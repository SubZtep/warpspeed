<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>WarpSpeed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script type="text/javascript" src="awt.min.js"></script>
  </head>
  <body>
    <a-scene vr-mode-ui="enabled: false" background="color: #000000" stats>
      <a-camera position="0 0 1.5"></a-camera>
      <a-entity id="box" geometry="primitive: box" position="0 0 0" warpspeed></a-entity>
    </a-scene>
    <script type="text/javascript">
      const sceneEl = document.querySelector("a-scene")
      const cameraEl = document.querySelector("a-camera")
      const el = document.querySelector("#box")

      const parseAttr = obj =>
        Object.entries(obj)
          .map(([key, value]) => `${key}: ${value}`)
          .join("; ")

      const gui = new dat.GUI()
      let wc

      const warpspeed = {
        width: 512,
        height: 512,
        speed: 3,
        density: 5,
        useCircles: true,
        depthAlpha: true,
        warpEffect: true,
        warpEffectLength: 5,
        starScale: 3,
        backgroundColor: "#000000",
        starColor: "#ffffff",
        useWorker: false,
      }

      const setWarpseed = () => {
        el.setAttribute("warpspeed", parseAttr(warpspeed))
        if (warpspeed.useWorker && !el.is("worker")) {
          wc.setValue(false)
          alert("Unable to transfer canvas control to worker thread!\n\nPlease, see the console for details.\n\nヾ( ￣O￣)ツ")
        }
      }

      gui.addColor({ background: "#000000" }, "background").onChange(color => sceneEl.setAttribute("background", `color: ${color}`))
      gui.add({ pause: false }, "pause").onChange(isPause => el[isPause ? "pause" : "play"]())
      wc = gui.add(warpspeed, "useWorker").onChange(setWarpseed)

      const ws = gui.addFolder("WarpSpeed")
      const resolutions = [2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096]
      ws.add(warpspeed, "width", resolutions).onChange(setWarpseed)
      ws.add(warpspeed, "height", resolutions).onChange(setWarpseed)
      ws.add(warpspeed, "speed", 0, 10, 0.1).onChange(setWarpseed)
      ws.add(warpspeed, "density", 0.1, 100.0, 0.1).onChange(setWarpseed)
      ws.add(warpspeed, "useCircles").onChange(setWarpseed)
      ws.add(warpspeed, "depthAlpha").onChange(setWarpseed)
      ws.add(warpspeed, "warpEffect").onChange(setWarpseed)
      ws.add(warpspeed, "warpEffectLength", 0, 100, 1).onChange(setWarpseed)
      ws.add(warpspeed, "starScale", 1, 100, 1).onChange(setWarpseed)
      ws.addColor(warpspeed, "backgroundColor").onChange(setWarpseed)
      ws.addColor(warpspeed, "starColor").onChange(setWarpseed)

      const geometry = {
        primitive: "box",
        box: {
          width: 1,
          height: 1,
          depth: 1,
        },
        plane: {
          width: 1,
          height: 1,
        },
        sphere: {
          radius: 1,
        },
        cone: {
          height: 1,
          radiusTop: 0.8,
          radiusBottom: 1,
        },
        ring: {
          radiusInner: 0.8,
          radiusOuter: 1.2,
        }
      }
      const setGeometry = () => el.setAttribute("geometry", `primitive: ${geometry.primitive};` + parseAttr(geometry[geometry.primitive]))
      const els = gui.addFolder("Entity")
      let geo = null

      const changePrimitive = primitive => {
        if (geo !== null) {
          els.removeFolder(geo)
        }
        geo = els.addFolder("Geometry")
        for (let key in geometry[primitive]) {
          geo.add(geometry[primitive], key, 0.1, 10.0, 0.1).onChange(setGeometry)
        }
        setGeometry()
      }

      els.add(geometry, "primitive", ["box", "plane", "sphere", "cone", "ring"]).onChange(changePrimitive)

      const rotation = {
        x: 0,
        y: 0,
        z: 0,
      }
      const setRotation = () => el.setAttribute("rotation", `${rotation.x} ${rotation.y} ${rotation.z}`)

      const rot = els.addFolder("Rotation")
      rot.add(rotation, "x", 0, 360).onChange(setRotation)
      rot.add(rotation, "y", 0, 360).onChange(setRotation)
      rot.add(rotation, "z", 0, 360).onChange(setRotation)

      changePrimitive("box")
      setWarpseed()
    </script>
  </body>
</html>
