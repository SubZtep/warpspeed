const randPos = () => (Math.random() - 0.5) * 1000;
const hex2rgb = webColor =>
  webColor.charAt(0) === "#" && webColor.length === 7
    ? {
        r: parseInt(webColor.substr(1, 2), 16),
        g: parseInt(webColor.substr(3, 2), 16),
        b: parseInt(webColor.substr(5, 2), 16),
      }
    : {
        r: 255,
        g: 255,
        b: 255,
      };

class Star {
  constructor(x, y, z) {
    this.x = x;
    this.y = y;
    this.z = z;
    this.size = 0.5 + Math.random();
  }
}

class WarpSpeed {
  config = {}
  stars = []

  constructor(canvas) {
    this.ctx = canvas.getContext("2d");
  }

  update(config) {
    //LiliCode: n vvvvvvvvvvvvvvvvvvj n n n n
    let resolutionUpdated = false;
    for (const [key, value] of Object.entries(config)) {
      if (this.config[key] !== value) {
        switch (key) {
          case "width":
          case "height":
          case "starScale":
            resolutionUpdated = true;
            break
          case "density":
            const starCount = Math.ceil(value * 1000);
            const diff = starCount - this.stars.length;
            if (diff > 0) {
              for (let i = 0; i < diff; i++) {
                const star = new Star(randPos(), randPos(), 1000 * Math.random());
                this.stars.push(star);
              }
            } else {
              this.stars.length = starCount;
            }
            break
          case "starColor":
            const color = hex2rgb(value);
            this.starR = color.r;
            this.starG = color.g;
            this.starB = color.b;
            break
        }
        this.config[key] = value;
      }
    }

    if (resolutionUpdated) {
      this.size = Math.max(this.config.width, this.config.height) / (10 / this.config.starScale);
      this.maxLineWidth = this.size / 30;
    }
  }

  draw(timeDelta) {
    this.move(timeDelta);

    const width = this.config.width;
    const height = this.config.height;
    this.size = Math.max(width, height) / (10 / this.config.starScale);

    const ctx = this.ctx;
    ctx.fillStyle = this.config.backgroundColor;
    ctx.fillRect(0, 0, width, height);

    for (const star of this.stars) {
      const xOnDisplay = star.x / star.z;
      const yOnDisplay = star.y / star.z;

      if (!this.config.warpEffect && (xOnDisplay < -0.5 || xOnDisplay > 0.5 || yOnDisplay < -0.5 || yOnDisplay > 0.5))
        continue

      const size = (star.size * this.size) / star.z;
      if (size < 0.3) continue //don't draw very small dots

      if (this.config.depthAlpha) {
        const alpha = (1000 - star.z) / 1000;
        ctx.fillStyle = `rgba(${this.starR}, ${this.starG}, ${this.starB}, ${alpha.toString()})`;
      } else {
        ctx.fillStyle = this.config.starColor;
      }

      if (this.config.warpEffect) {
        ctx.beginPath();
        const x2OnDisplay = star.x / (star.z + this.config.warpEffectLength * this.config.speed);
        const y2OnDisplay = star.y / (star.z + this.config.warpEffectLength * this.config.speed);

        if (x2OnDisplay < -0.5 || x2OnDisplay > 0.5 || y2OnDisplay < -0.5 || y2OnDisplay > 0.5) continue

        ctx.moveTo(width * (xOnDisplay + 0.5) - size / 2, height * (yOnDisplay + 0.5) - size / 2);
        ctx.lineTo(width * (x2OnDisplay + 0.5) - size / 2, height * (y2OnDisplay + 0.5) - size / 2);
        ctx.lineWidth = Math.min(size, this.maxLineWidth);
        ctx.lineCap = this.config.useCircles ? "round" : "butt";
        ctx.strokeStyle = ctx.fillStyle;
        ctx.stroke();
      } else if (this.config.useCircles) {
        ctx.beginPath();
        ctx.arc(width * (xOnDisplay + 0.5) - size / 2, height * (yOnDisplay + 0.5) - size / 2, size / 2, 0, 2 * Math.PI);
        ctx.fill();
      } else {
        ctx.fillRect(width * (xOnDisplay + 0.5) - size / 2, height * (yOnDisplay + 0.5) - size / 2, size, size);
      }
    }
  }

  move(timeDelta) {
    const speed = this.config.speed * (timeDelta / 10);

    for (const star of this.stars) {
      star.z -= speed;
      while (star.z < 1) {
        star.z += 1000;
        star.x = (Math.random() - 0.5) * star.z;
        star.y = (Math.random() - 0.5) * star.z;
      }
    }
  }
}

function decodeBase64(base64, enableUnicode) {
    var binaryString = atob(base64);
    if (enableUnicode) {
        var binaryView = new Uint8Array(binaryString.length);
        for (var i = 0, n = binaryString.length; i < n; ++i) {
            binaryView[i] = binaryString.charCodeAt(i);
        }
        return String.fromCharCode.apply(null, new Uint16Array(binaryView.buffer));
    }
    return binaryString;
}

function createURL(base64, sourcemapArg, enableUnicodeArg) {
    var sourcemap = sourcemapArg === undefined ? null : sourcemapArg;
    var enableUnicode = enableUnicodeArg === undefined ? false : enableUnicodeArg;
    var source = decodeBase64(base64, enableUnicode);
    var start = source.indexOf('\n', 10) + 1;
    var body = source.substring(start) + (sourcemap ? '\/\/# sourceMappingURL=' + sourcemap : '');
    var blob = new Blob([body], { type: 'application/javascript' });
    return URL.createObjectURL(blob);
}

function createBase64WorkerFactory(base64, sourcemapArg, enableUnicodeArg) {
    var url;
    return function WorkerFactory(options) {
        url = url || createURL(base64, sourcemapArg, enableUnicodeArg);
        return new Worker(url, options);
    };
}

var WorkerFactory = createBase64WorkerFactory('Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgY29uc3QgcmFuZFBvcyA9ICgpID0+IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwMDA7CiAgY29uc3QgaGV4MnJnYiA9IHdlYkNvbG9yID0+CiAgICB3ZWJDb2xvci5jaGFyQXQoMCkgPT09ICIjIiAmJiB3ZWJDb2xvci5sZW5ndGggPT09IDcKICAgICAgPyB7CiAgICAgICAgICByOiBwYXJzZUludCh3ZWJDb2xvci5zdWJzdHIoMSwgMiksIDE2KSwKICAgICAgICAgIGc6IHBhcnNlSW50KHdlYkNvbG9yLnN1YnN0cigzLCAyKSwgMTYpLAogICAgICAgICAgYjogcGFyc2VJbnQod2ViQ29sb3Iuc3Vic3RyKDUsIDIpLCAxNiksCiAgICAgICAgfQogICAgICA6IHsKICAgICAgICAgIHI6IDI1NSwKICAgICAgICAgIGc6IDI1NSwKICAgICAgICAgIGI6IDI1NSwKICAgICAgICB9OwoKICBjbGFzcyBTdGFyIHsKICAgIGNvbnN0cnVjdG9yKHgsIHksIHopIHsKICAgICAgdGhpcy54ID0geDsKICAgICAgdGhpcy55ID0geTsKICAgICAgdGhpcy56ID0gejsKICAgICAgdGhpcy5zaXplID0gMC41ICsgTWF0aC5yYW5kb20oKTsKICAgIH0KICB9CgogIGNsYXNzIFdhcnBTcGVlZCB7CiAgICBjb25maWcgPSB7fQogICAgc3RhcnMgPSBbXQoKICAgIGNvbnN0cnVjdG9yKGNhbnZhcykgewogICAgICB0aGlzLmN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgfQoKICAgIHVwZGF0ZShjb25maWcpIHsKICAgICAgLy9MaWxpQ29kZTogbiB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZqIG4gbiBuIG4KICAgICAgbGV0IHJlc29sdXRpb25VcGRhdGVkID0gZmFsc2U7CiAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGNvbmZpZykpIHsKICAgICAgICBpZiAodGhpcy5jb25maWdba2V5XSAhPT0gdmFsdWUpIHsKICAgICAgICAgIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgICAgIGNhc2UgIndpZHRoIjoKICAgICAgICAgICAgY2FzZSAiaGVpZ2h0IjoKICAgICAgICAgICAgY2FzZSAic3RhclNjYWxlIjoKICAgICAgICAgICAgICByZXNvbHV0aW9uVXBkYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgY2FzZSAiZGVuc2l0eSI6CiAgICAgICAgICAgICAgY29uc3Qgc3RhckNvdW50ID0gTWF0aC5jZWlsKHZhbHVlICogMTAwMCk7CiAgICAgICAgICAgICAgY29uc3QgZGlmZiA9IHN0YXJDb3VudCAtIHRoaXMuc3RhcnMubGVuZ3RoOwogICAgICAgICAgICAgIGlmIChkaWZmID4gMCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkaWZmOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhciA9IG5ldyBTdGFyKHJhbmRQb3MoKSwgcmFuZFBvcygpLCAxMDAwICogTWF0aC5yYW5kb20oKSk7CiAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnMucHVzaChzdGFyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zdGFycy5sZW5ndGggPSBzdGFyQ291bnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGNhc2UgInN0YXJDb2xvciI6CiAgICAgICAgICAgICAgY29uc3QgY29sb3IgPSBoZXgycmdiKHZhbHVlKTsKICAgICAgICAgICAgICB0aGlzLnN0YXJSID0gY29sb3IucjsKICAgICAgICAgICAgICB0aGlzLnN0YXJHID0gY29sb3IuZzsKICAgICAgICAgICAgICB0aGlzLnN0YXJCID0gY29sb3IuYjsKICAgICAgICAgICAgICBicmVhawogICAgICAgICAgfQogICAgICAgICAgdGhpcy5jb25maWdba2V5XSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHJlc29sdXRpb25VcGRhdGVkKSB7CiAgICAgICAgdGhpcy5zaXplID0gTWF0aC5tYXgodGhpcy5jb25maWcud2lkdGgsIHRoaXMuY29uZmlnLmhlaWdodCkgLyAoMTAgLyB0aGlzLmNvbmZpZy5zdGFyU2NhbGUpOwogICAgICAgIHRoaXMubWF4TGluZVdpZHRoID0gdGhpcy5zaXplIC8gMzA7CiAgICAgIH0KICAgIH0KCiAgICBkcmF3KHRpbWVEZWx0YSkgewogICAgICB0aGlzLm1vdmUodGltZURlbHRhKTsKCiAgICAgIGNvbnN0IHdpZHRoID0gdGhpcy5jb25maWcud2lkdGg7CiAgICAgIGNvbnN0IGhlaWdodCA9IHRoaXMuY29uZmlnLmhlaWdodDsKICAgICAgdGhpcy5zaXplID0gTWF0aC5tYXgod2lkdGgsIGhlaWdodCkgLyAoMTAgLyB0aGlzLmNvbmZpZy5zdGFyU2NhbGUpOwoKICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmNvbmZpZy5iYWNrZ3JvdW5kQ29sb3I7CiAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCiAgICAgIGZvciAoY29uc3Qgc3RhciBvZiB0aGlzLnN0YXJzKSB7CiAgICAgICAgY29uc3QgeE9uRGlzcGxheSA9IHN0YXIueCAvIHN0YXIuejsKICAgICAgICBjb25zdCB5T25EaXNwbGF5ID0gc3Rhci55IC8gc3Rhci56OwoKICAgICAgICBpZiAoIXRoaXMuY29uZmlnLndhcnBFZmZlY3QgJiYgKHhPbkRpc3BsYXkgPCAtMC41IHx8IHhPbkRpc3BsYXkgPiAwLjUgfHwgeU9uRGlzcGxheSA8IC0wLjUgfHwgeU9uRGlzcGxheSA+IDAuNSkpCiAgICAgICAgICBjb250aW51ZQoKICAgICAgICBjb25zdCBzaXplID0gKHN0YXIuc2l6ZSAqIHRoaXMuc2l6ZSkgLyBzdGFyLno7CiAgICAgICAgaWYgKHNpemUgPCAwLjMpIGNvbnRpbnVlIC8vZG9uJ3QgZHJhdyB2ZXJ5IHNtYWxsIGRvdHMKCiAgICAgICAgaWYgKHRoaXMuY29uZmlnLmRlcHRoQWxwaGEpIHsKICAgICAgICAgIGNvbnN0IGFscGhhID0gKDEwMDAgLSBzdGFyLnopIC8gMTAwMDsKICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBgcmdiYSgke3RoaXMuc3RhclJ9LCAke3RoaXMuc3Rhckd9LCAke3RoaXMuc3RhckJ9LCAke2FscGhhLnRvU3RyaW5nKCl9KWA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmNvbmZpZy5zdGFyQ29sb3I7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jb25maWcud2FycEVmZmVjdCkgewogICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgY29uc3QgeDJPbkRpc3BsYXkgPSBzdGFyLnggLyAoc3Rhci56ICsgdGhpcy5jb25maWcud2FycEVmZmVjdExlbmd0aCAqIHRoaXMuY29uZmlnLnNwZWVkKTsKICAgICAgICAgIGNvbnN0IHkyT25EaXNwbGF5ID0gc3Rhci55IC8gKHN0YXIueiArIHRoaXMuY29uZmlnLndhcnBFZmZlY3RMZW5ndGggKiB0aGlzLmNvbmZpZy5zcGVlZCk7CgogICAgICAgICAgaWYgKHgyT25EaXNwbGF5IDwgLTAuNSB8fCB4Mk9uRGlzcGxheSA+IDAuNSB8fCB5Mk9uRGlzcGxheSA8IC0wLjUgfHwgeTJPbkRpc3BsYXkgPiAwLjUpIGNvbnRpbnVlCgogICAgICAgICAgY3R4Lm1vdmVUbyh3aWR0aCAqICh4T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBoZWlnaHQgKiAoeU9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMik7CiAgICAgICAgICBjdHgubGluZVRvKHdpZHRoICogKHgyT25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBoZWlnaHQgKiAoeTJPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIpOwogICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IE1hdGgubWluKHNpemUsIHRoaXMubWF4TGluZVdpZHRoKTsKICAgICAgICAgIGN0eC5saW5lQ2FwID0gdGhpcy5jb25maWcudXNlQ2lyY2xlcyA/ICJyb3VuZCIgOiAiYnV0dCI7CiAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBjdHguZmlsbFN0eWxlOwogICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5jb25maWcudXNlQ2lyY2xlcykgewogICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgY3R4LmFyYyh3aWR0aCAqICh4T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBoZWlnaHQgKiAoeU9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgc2l6ZSAvIDIsIDAsIDIgKiBNYXRoLlBJKTsKICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN0eC5maWxsUmVjdCh3aWR0aCAqICh4T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBoZWlnaHQgKiAoeU9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgc2l6ZSwgc2l6ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgbW92ZSh0aW1lRGVsdGEpIHsKICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLmNvbmZpZy5zcGVlZCAqICh0aW1lRGVsdGEgLyAxMCk7CgogICAgICBmb3IgKGNvbnN0IHN0YXIgb2YgdGhpcy5zdGFycykgewogICAgICAgIHN0YXIueiAtPSBzcGVlZDsKICAgICAgICB3aGlsZSAoc3Rhci56IDwgMSkgewogICAgICAgICAgc3Rhci56ICs9IDEwMDA7CiAgICAgICAgICBzdGFyLnggPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzdGFyLno7CiAgICAgICAgICBzdGFyLnkgPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzdGFyLno7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBsZXQgd2FycHNwZWVkOwogIGxldCBsYXN0VGltZTsKICBsZXQgcGF1c2VkOwoKICBjb25zdCB0aWNrID0gdGltZSA9PiB7CiAgICBpZiAocGF1c2VkKSByZXR1cm4KICAgIHdhcnBzcGVlZC5kcmF3KGxhc3RUaW1lID09PSBudWxsID8gMSA6IHRpbWUgLSBsYXN0VGltZSk7CiAgICBsYXN0VGltZSA9IHRpbWU7CiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGljayk7CiAgfTsKCiAgb25tZXNzYWdlID0gKHsgZGF0YTogeyBjYW52YXMsIGNvbmZpZywgcGF1c2UgfSB9KSA9PiB7CiAgICBpZiAoY2FudmFzICE9PSB1bmRlZmluZWQpIHsKICAgICAgd2FycHNwZWVkID0gbmV3IFdhcnBTcGVlZChjYW52YXMpOwogICAgfQoKICAgIGlmIChjb25maWcgIT09IHVuZGVmaW5lZCkgewogICAgICB3YXJwc3BlZWQudXBkYXRlKGNvbmZpZyk7CiAgICB9CgogICAgaWYgKHBhdXNlICE9PSB1bmRlZmluZWQpIHsKICAgICAgcGF1c2VkID0gcGF1c2U7CiAgICAgIGlmICghcGF1c2VkKSB7CiAgICAgICAgbGFzdFRpbWUgPSBudWxsOwogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKTsKICAgICAgfQogICAgfQogIH07Cgp9KCkpOwoK', 'data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLmpzIiwic291cmNlcyI6WyJ3b3JrZXI6L0M6XFx3ZWItd29ya2VyXFx3YXJwc3BlZWQuanMiLCJ3b3JrZXI6L0M6XFx3ZWItd29ya2VyXFx3b3JrZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcmFuZFBvcyA9ICgpID0+IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwMDBcbmNvbnN0IGhleDJyZ2IgPSB3ZWJDb2xvciA9PlxuICB3ZWJDb2xvci5jaGFyQXQoMCkgPT09IFwiI1wiICYmIHdlYkNvbG9yLmxlbmd0aCA9PT0gN1xuICAgID8ge1xuICAgICAgICByOiBwYXJzZUludCh3ZWJDb2xvci5zdWJzdHIoMSwgMiksIDE2KSxcbiAgICAgICAgZzogcGFyc2VJbnQod2ViQ29sb3Iuc3Vic3RyKDMsIDIpLCAxNiksXG4gICAgICAgIGI6IHBhcnNlSW50KHdlYkNvbG9yLnN1YnN0cig1LCAyKSwgMTYpLFxuICAgICAgfVxuICAgIDoge1xuICAgICAgICByOiAyNTUsXG4gICAgICAgIGc6IDI1NSxcbiAgICAgICAgYjogMjU1LFxuICAgICAgfVxuXG5jbGFzcyBTdGFyIHtcbiAgY29uc3RydWN0b3IoeCwgeSwgeikge1xuICAgIHRoaXMueCA9IHhcbiAgICB0aGlzLnkgPSB5XG4gICAgdGhpcy56ID0gelxuICAgIHRoaXMuc2l6ZSA9IDAuNSArIE1hdGgucmFuZG9tKClcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXYXJwU3BlZWQge1xuICBjb25maWcgPSB7fVxuICBzdGFycyA9IFtdXG5cbiAgY29uc3RydWN0b3IoY2FudmFzKSB7XG4gICAgdGhpcy5jdHggPSBjYW52YXMuZ2V0Q29udGV4dChcIjJkXCIpXG4gIH1cblxuICB1cGRhdGUoY29uZmlnKSB7XG4gICAgLy9MaWxpQ29kZTogbiB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZqIG4gbiBuIG5cbiAgICBsZXQgcmVzb2x1dGlvblVwZGF0ZWQgPSBmYWxzZVxuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGNvbmZpZykpIHtcbiAgICAgIGlmICh0aGlzLmNvbmZpZ1trZXldICE9PSB2YWx1ZSkge1xuICAgICAgICBzd2l0Y2ggKGtleSkge1xuICAgICAgICAgIGNhc2UgXCJ3aWR0aFwiOlxuICAgICAgICAgIGNhc2UgXCJoZWlnaHRcIjpcbiAgICAgICAgICBjYXNlIFwic3RhclNjYWxlXCI6XG4gICAgICAgICAgICByZXNvbHV0aW9uVXBkYXRlZCA9IHRydWVcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSBcImRlbnNpdHlcIjpcbiAgICAgICAgICAgIGNvbnN0IHN0YXJDb3VudCA9IE1hdGguY2VpbCh2YWx1ZSAqIDEwMDApXG4gICAgICAgICAgICBjb25zdCBkaWZmID0gc3RhckNvdW50IC0gdGhpcy5zdGFycy5sZW5ndGhcbiAgICAgICAgICAgIGlmIChkaWZmID4gMCkge1xuICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRpZmY7IGkrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0YXIgPSBuZXcgU3RhcihyYW5kUG9zKCksIHJhbmRQb3MoKSwgMTAwMCAqIE1hdGgucmFuZG9tKCkpXG4gICAgICAgICAgICAgICAgdGhpcy5zdGFycy5wdXNoKHN0YXIpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRoaXMuc3RhcnMubGVuZ3RoID0gc3RhckNvdW50XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIGNhc2UgXCJzdGFyQ29sb3JcIjpcbiAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gaGV4MnJnYih2YWx1ZSlcbiAgICAgICAgICAgIHRoaXMuc3RhclIgPSBjb2xvci5yXG4gICAgICAgICAgICB0aGlzLnN0YXJHID0gY29sb3IuZ1xuICAgICAgICAgICAgdGhpcy5zdGFyQiA9IGNvbG9yLmJcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb25maWdba2V5XSA9IHZhbHVlXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHJlc29sdXRpb25VcGRhdGVkKSB7XG4gICAgICB0aGlzLnNpemUgPSBNYXRoLm1heCh0aGlzLmNvbmZpZy53aWR0aCwgdGhpcy5jb25maWcuaGVpZ2h0KSAvICgxMCAvIHRoaXMuY29uZmlnLnN0YXJTY2FsZSlcbiAgICAgIHRoaXMubWF4TGluZVdpZHRoID0gdGhpcy5zaXplIC8gMzBcbiAgICB9XG4gIH1cblxuICBkcmF3KHRpbWVEZWx0YSkge1xuICAgIHRoaXMubW92ZSh0aW1lRGVsdGEpXG5cbiAgICBjb25zdCB3aWR0aCA9IHRoaXMuY29uZmlnLndpZHRoXG4gICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5jb25maWcuaGVpZ2h0XG4gICAgdGhpcy5zaXplID0gTWF0aC5tYXgod2lkdGgsIGhlaWdodCkgLyAoMTAgLyB0aGlzLmNvbmZpZy5zdGFyU2NhbGUpXG5cbiAgICBjb25zdCBjdHggPSB0aGlzLmN0eFxuICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmNvbmZpZy5iYWNrZ3JvdW5kQ29sb3JcbiAgICBjdHguZmlsbFJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodClcblxuICAgIGZvciAoY29uc3Qgc3RhciBvZiB0aGlzLnN0YXJzKSB7XG4gICAgICBjb25zdCB4T25EaXNwbGF5ID0gc3Rhci54IC8gc3Rhci56XG4gICAgICBjb25zdCB5T25EaXNwbGF5ID0gc3Rhci55IC8gc3Rhci56XG5cbiAgICAgIGlmICghdGhpcy5jb25maWcud2FycEVmZmVjdCAmJiAoeE9uRGlzcGxheSA8IC0wLjUgfHwgeE9uRGlzcGxheSA+IDAuNSB8fCB5T25EaXNwbGF5IDwgLTAuNSB8fCB5T25EaXNwbGF5ID4gMC41KSlcbiAgICAgICAgY29udGludWVcblxuICAgICAgY29uc3Qgc2l6ZSA9IChzdGFyLnNpemUgKiB0aGlzLnNpemUpIC8gc3Rhci56XG4gICAgICBpZiAoc2l6ZSA8IDAuMykgY29udGludWUgLy9kb24ndCBkcmF3IHZlcnkgc21hbGwgZG90c1xuXG4gICAgICBpZiAodGhpcy5jb25maWcuZGVwdGhBbHBoYSkge1xuICAgICAgICBjb25zdCBhbHBoYSA9ICgxMDAwIC0gc3Rhci56KSAvIDEwMDBcbiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGByZ2JhKCR7dGhpcy5zdGFyUn0sICR7dGhpcy5zdGFyR30sICR7dGhpcy5zdGFyQn0sICR7YWxwaGEudG9TdHJpbmcoKX0pYFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IHRoaXMuY29uZmlnLnN0YXJDb2xvclxuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5jb25maWcud2FycEVmZmVjdCkge1xuICAgICAgICBjdHguYmVnaW5QYXRoKClcbiAgICAgICAgY29uc3QgeDJPbkRpc3BsYXkgPSBzdGFyLnggLyAoc3Rhci56ICsgdGhpcy5jb25maWcud2FycEVmZmVjdExlbmd0aCAqIHRoaXMuY29uZmlnLnNwZWVkKVxuICAgICAgICBjb25zdCB5Mk9uRGlzcGxheSA9IHN0YXIueSAvIChzdGFyLnogKyB0aGlzLmNvbmZpZy53YXJwRWZmZWN0TGVuZ3RoICogdGhpcy5jb25maWcuc3BlZWQpXG5cbiAgICAgICAgaWYgKHgyT25EaXNwbGF5IDwgLTAuNSB8fCB4Mk9uRGlzcGxheSA+IDAuNSB8fCB5Mk9uRGlzcGxheSA8IC0wLjUgfHwgeTJPbkRpc3BsYXkgPiAwLjUpIGNvbnRpbnVlXG5cbiAgICAgICAgY3R4Lm1vdmVUbyh3aWR0aCAqICh4T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBoZWlnaHQgKiAoeU9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMilcbiAgICAgICAgY3R4LmxpbmVUbyh3aWR0aCAqICh4Mk9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgaGVpZ2h0ICogKHkyT25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyKVxuICAgICAgICBjdHgubGluZVdpZHRoID0gTWF0aC5taW4oc2l6ZSwgdGhpcy5tYXhMaW5lV2lkdGgpXG4gICAgICAgIGN0eC5saW5lQ2FwID0gdGhpcy5jb25maWcudXNlQ2lyY2xlcyA/IFwicm91bmRcIiA6IFwiYnV0dFwiXG4gICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGN0eC5maWxsU3R5bGVcbiAgICAgICAgY3R4LnN0cm9rZSgpXG4gICAgICB9IGVsc2UgaWYgKHRoaXMuY29uZmlnLnVzZUNpcmNsZXMpIHtcbiAgICAgICAgY3R4LmJlZ2luUGF0aCgpXG4gICAgICAgIGN0eC5hcmMod2lkdGggKiAoeE9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgaGVpZ2h0ICogKHlPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIHNpemUgLyAyLCAwLCAyICogTWF0aC5QSSlcbiAgICAgICAgY3R4LmZpbGwoKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY3R4LmZpbGxSZWN0KHdpZHRoICogKHhPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIGhlaWdodCAqICh5T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBzaXplLCBzaXplKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG1vdmUodGltZURlbHRhKSB7XG4gICAgY29uc3Qgc3BlZWQgPSB0aGlzLmNvbmZpZy5zcGVlZCAqICh0aW1lRGVsdGEgLyAxMClcblxuICAgIGZvciAoY29uc3Qgc3RhciBvZiB0aGlzLnN0YXJzKSB7XG4gICAgICBzdGFyLnogLT0gc3BlZWRcbiAgICAgIHdoaWxlIChzdGFyLnogPCAxKSB7XG4gICAgICAgIHN0YXIueiArPSAxMDAwXG4gICAgICAgIHN0YXIueCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHN0YXIuelxuICAgICAgICBzdGFyLnkgPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzdGFyLnpcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiIsImltcG9ydCBXYXJwU3BlZWQgZnJvbSBcIi4vd2FycHNwZWVkXCJcblxubGV0IHdhcnBzcGVlZFxubGV0IGxhc3RUaW1lXG5sZXQgcGF1c2VkXG5cbmNvbnN0IHRpY2sgPSB0aW1lID0+IHtcbiAgaWYgKHBhdXNlZCkgcmV0dXJuXG4gIHdhcnBzcGVlZC5kcmF3KGxhc3RUaW1lID09PSBudWxsID8gMSA6IHRpbWUgLSBsYXN0VGltZSlcbiAgbGFzdFRpbWUgPSB0aW1lXG4gIHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKVxufVxuXG5vbm1lc3NhZ2UgPSAoeyBkYXRhOiB7IGNhbnZhcywgY29uZmlnLCBwYXVzZSB9IH0pID0+IHtcbiAgaWYgKGNhbnZhcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgd2FycHNwZWVkID0gbmV3IFdhcnBTcGVlZChjYW52YXMpXG4gIH1cblxuICBpZiAoY29uZmlnICE9PSB1bmRlZmluZWQpIHtcbiAgICB3YXJwc3BlZWQudXBkYXRlKGNvbmZpZylcbiAgfVxuXG4gIGlmIChwYXVzZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgcGF1c2VkID0gcGF1c2VcbiAgICBpZiAoIXBhdXNlZCkge1xuICAgICAgbGFzdFRpbWUgPSBudWxsXG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGljaylcbiAgICB9XG4gIH1cbn1cbiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7RUFBQSxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEdBQUcsSUFBSSxLQUFJO0VBQ2xELE1BQU0sT0FBTyxHQUFHLFFBQVE7RUFDeEIsRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUM7RUFDckQsTUFBTTtFQUNOLFFBQVEsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7RUFDOUMsUUFBUSxDQUFDLEVBQUUsUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FB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', false);
/* eslint-enable */

AFRAME.registerComponent("warpspeed", {
  schema: {
    width: {
      type: "number",
      default: 512,
    },
    height: {
      type: "number",
      default: 512,
    },
    speed: {
      type: "number",
      default: 0.7,
    },
    density: {
      type: "number",
      // default: 0.7, // min: >0
      default: 25.7, // min: >0
    },
    useCircles: {
      type: "boolean",
      default: true,
    },
    depthAlpha: {
      type: "boolean",
      default: true,
    },
    warpEffect: {
      type: "boolean",
      default: true,
    },
    warpEffectLength: {
      type: "number",
      default: 5, // min: 0
    },
    starScale: {
      type: "number",
      default: 3, // min: >0
    },
    backgroundColor: {
      type: "color",
      default: "#100a1a",
    },
    starColor: {
      type: "color",
      default: "#ffffff",
    },
    useWorker: {
      type: "boolean",
      default: false,
    },
  },

  update(oldData) {
    if (
      oldData.useWorker !== this.data.useWorker ||
      oldData.width !== this.data.width ||
      oldData.height !== this.data.height
    ) {
      if (oldData.useWorker !== undefined) {
        if (oldData.useWorker) {
          this.worker.terminate();
          delete this.worker;
        } else {
          delete this.warpspeed;
        }
        this.canvasMap.dispose();
        delete this.canvas;
      }

      this.canvas = document.createElement("canvas");
      this.canvas.width = this.data.width;
      this.canvas.height = this.data.height;

      this.canvasMap = new THREE.Texture(this.canvas);
      this.el.getObject3D("mesh").material.map = this.canvasMap;

      if (this.data.useWorker) {
        const offscreen = this.canvas.transferControlToOffscreen();
        this.worker = new WorkerFactory();
        this.worker.postMessage({ canvas: offscreen }, [offscreen]);
      } else {
        this.warpspeed = new WarpSpeed(this.canvas);
      }
    }

    if (this.data.useWorker) {
      this.worker.postMessage({ config: this.data, pause: !this.isPlaying });
    } else {
      this.warpspeed.update(this.data);
    }
  },

  play() {
    if (this.data.useWorker) {
      this.worker.postMessage({ pause: false });
    }
  },

  pause() {
    if (this.data.useWorker) {
      this.worker.postMessage({ pause: true });
    }
  },

  tick(_time, timeDelta) {
    if (!this.data.useWorker) {
      this.warpspeed.draw(timeDelta);
    }
    this.canvasMap.needsUpdate = true;
  },
});
