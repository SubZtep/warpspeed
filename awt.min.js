class Star {
  constructor(x, y, z) {
    this.x = x;
    this.y = y;
    this.z = z;
    this.size = 0.5 + Math.random();
  }
}

class WarpSpeed {

  config = {}
  stars = []

  starR = 255
  starG = 255
  starB = 255

  constructor(canvas) {
    this.canvas = canvas;
    this.ctx = this.canvas.getContext("2d");
  }

  update(config) {
    //LiliCode: n vvvvvvvvvvvvvvvvvvj n n n n
    for (const [key, value] of Object.entries(config)) {
      // console.log(key)
      if (this.config[key] !== value) {
        switch (key) {
          // case "backgroundColor":
          //   this.ctx.fillStyle = this.config.backgroundColor
          //   // this.ctx.fillRect(0, 0, width, height)
          //   this.ctx.fillRect(0, 0, 512, 512)
          // break
          case "speed":
          case "targetSpeed":
          case "speedAdjFactor":
            this.speed = key === "speed" ? value : this.config.speed || 0.7;
            break
          case "resolution":
            if (this.config.starScale !== undefined) {
              this.size = value / (10 / this.config.starScale);
              this.maxLineWidth = this.size / 30;
            }
            break
          case "starScale":
            if (this.config.resolution !== undefined) {
              this.size = this.config.resolution / (10 / value);
              this.maxLineWidth = this.size / 30;
            }
            break
          case "density":
            const len = Math.ceil(value * 1000);
            const diff = len - this.stars.length;
            if (diff > 0) {
              for (let i = 0; i < diff; i++) {
                this.stars.push(
                  new Star((Math.random() - 0.5) * 1000, (Math.random() - 0.5) * 1000, 1000 * Math.random())
                );
              }
            } else {
              this.stars.length = len;
            }
            break
          case "starColor":
            if (value.charAt(0) === "#" && value.length === 7) {
              this.starR = parseInt(value.substr(1, 2), 16);
              this.starG = parseInt(value.substr(3, 2), 16);
              this.starB = parseInt(value.substr(5, 2), 16);
            } else {
              continue
            }
            break
        }
        this.config[key] = value;
      }
    }
  }

  draw(timeDelta) {
    this.move(timeDelta);

    const width = this.config.resolution;
    const height = this.config.resolution;
    this.size = Math.max(width, height) / (10 / this.config.starScale);

    const ctx = this.ctx;
    ctx.fillStyle = this.config.backgroundColor;
    ctx.fillRect(0, 0, width, height);

    for (const s of this.stars) {
      const xOnDisplay = s.x / s.z;
      const yOnDisplay = s.y / s.z;

      if (!this.config.warpEffect && (xOnDisplay < -0.5 || xOnDisplay > 0.5 || yOnDisplay < -0.5 || yOnDisplay > 0.5))
        continue

      const size = (s.size * this.size) / s.z;
      if (size < 0.3) continue //don't draw very small dots

      if (this.config.depthAlpha) {
        const alpha = (1000 - s.z) / 1000;
        ctx.fillStyle = `rgba(${this.starR},${this.starG},${this.starB},${alpha.toString()})`;
      } else {
        ctx.fillStyle = `rgb(${this.starR},${this.starG},${this.starB})`; //rgb
      }

      if (this.config.warpEffect) {
        ctx.beginPath();
        const x2OnDisplay = s.x / (s.z + this.config.warpEffectLength * this.speed);
        const y2OnDisplay = s.y / (s.z + this.config.warpEffectLength * this.speed);

        if (x2OnDisplay < -0.5 || x2OnDisplay > 0.5 || y2OnDisplay < -0.5 || y2OnDisplay > 0.5) continue

        ctx.moveTo(width * (xOnDisplay + 0.5) - size / 2, height * (yOnDisplay + 0.5) - size / 2);
        ctx.lineTo(width * (x2OnDisplay + 0.5) - size / 2, height * (y2OnDisplay + 0.5) - size / 2);
        ctx.lineWidth = size > this.maxLineWidth ? this.maxLineWidth : size;
        ctx.lineCap = this.config.useCircles ? "round" : "butt";
        ctx.strokeStyle = ctx.fillStyle;
        ctx.stroke();
      } else if (this.config.useCircles) {
        ctx.beginPath();
        ctx.arc(width * (xOnDisplay + 0.5) - size / 2, height * (yOnDisplay + 0.5) - size / 2, size / 2, 0, 2 * Math.PI);
        ctx.fill();
      } else {
        ctx.fillRect(width * (xOnDisplay + 0.5) - size / 2, height * (yOnDisplay + 0.5) - size / 2, size, size);
      }
    }
  }

  move(timeDelta) {
    const speedMulF = timeDelta / 16.5;
    const speedAdjF = Math.pow(this.config.speedAdjFactor, 1 / speedMulF);
    this.speed = this.config.targetSpeed * speedAdjF + this.speed * (1 - speedAdjF);
    if (this.speed < 0) this.speed = 0;
    const speed = this.speed * speedMulF;

    for (const s of this.stars) {
      s.z -= speed;
      while (s.z < 1) {
        s.z += 1000;
        s.x = (Math.random() - 0.5) * s.z;
        s.y = (Math.random() - 0.5) * s.z;
      }
    }
  }
}

function decodeBase64(base64, enableUnicode) {
    var binaryString = atob(base64);
    if (enableUnicode) {
        var binaryView = new Uint8Array(binaryString.length);
        for (var i = 0, n = binaryString.length; i < n; ++i) {
            binaryView[i] = binaryString.charCodeAt(i);
        }
        return String.fromCharCode.apply(null, new Uint16Array(binaryView.buffer));
    }
    return binaryString;
}

function createURL(base64, sourcemapArg, enableUnicodeArg) {
    var sourcemap = sourcemapArg === undefined ? null : sourcemapArg;
    var enableUnicode = enableUnicodeArg === undefined ? false : enableUnicodeArg;
    var source = decodeBase64(base64, enableUnicode);
    var start = source.indexOf('\n', 10) + 1;
    var body = source.substring(start) + (sourcemap ? '\/\/# sourceMappingURL=' + sourcemap : '');
    var blob = new Blob([body], { type: 'application/javascript' });
    return URL.createObjectURL(blob);
}

function createBase64WorkerFactory(base64, sourcemapArg, enableUnicodeArg) {
    var url;
    return function WorkerFactory(options) {
        url = url || createURL(base64, sourcemapArg, enableUnicodeArg);
        return new Worker(url, options);
    };
}

var WorkerFactory = createBase64WorkerFactory('Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgY2xhc3MgU3RhciB7CiAgICBjb25zdHJ1Y3Rvcih4LCB5LCB6KSB7CiAgICAgIHRoaXMueCA9IHg7CiAgICAgIHRoaXMueSA9IHk7CiAgICAgIHRoaXMueiA9IHo7CiAgICAgIHRoaXMuc2l6ZSA9IDAuNSArIE1hdGgucmFuZG9tKCk7CiAgICB9CiAgfQoKICBjbGFzcyBXYXJwU3BlZWQgewoKICAgIGNvbmZpZyA9IHt9CiAgICBzdGFycyA9IFtdCgogICAgc3RhclIgPSAyNTUKICAgIHN0YXJHID0gMjU1CiAgICBzdGFyQiA9IDI1NQoKICAgIGNvbnN0cnVjdG9yKGNhbnZhcykgewogICAgICB0aGlzLmNhbnZhcyA9IGNhbnZhczsKICAgICAgdGhpcy5jdHggPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgfQoKICAgIHVwZGF0ZShjb25maWcpIHsKICAgICAgLy9MaWxpQ29kZTogbiB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZqIG4gbiBuIG4KICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoY29uZmlnKSkgewogICAgICAgIC8vIGNvbnNvbGUubG9nKGtleSkKICAgICAgICBpZiAodGhpcy5jb25maWdba2V5XSAhPT0gdmFsdWUpIHsKICAgICAgICAgIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgICAgIC8vIGNhc2UgImJhY2tncm91bmRDb2xvciI6CiAgICAgICAgICAgIC8vICAgdGhpcy5jdHguZmlsbFN0eWxlID0gdGhpcy5jb25maWcuYmFja2dyb3VuZENvbG9yCiAgICAgICAgICAgIC8vICAgLy8gdGhpcy5jdHguZmlsbFJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodCkKICAgICAgICAgICAgLy8gICB0aGlzLmN0eC5maWxsUmVjdCgwLCAwLCA1MTIsIDUxMikKICAgICAgICAgICAgLy8gYnJlYWsKICAgICAgICAgICAgY2FzZSAic3BlZWQiOgogICAgICAgICAgICBjYXNlICJ0YXJnZXRTcGVlZCI6CiAgICAgICAgICAgIGNhc2UgInNwZWVkQWRqRmFjdG9yIjoKICAgICAgICAgICAgICB0aGlzLnNwZWVkID0ga2V5ID09PSAic3BlZWQiID8gdmFsdWUgOiB0aGlzLmNvbmZpZy5zcGVlZCB8fCAwLjc7CiAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgY2FzZSAicmVzb2x1dGlvbiI6CiAgICAgICAgICAgICAgaWYgKHRoaXMuY29uZmlnLnN0YXJTY2FsZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNpemUgPSB2YWx1ZSAvICgxMCAvIHRoaXMuY29uZmlnLnN0YXJTY2FsZSk7CiAgICAgICAgICAgICAgICB0aGlzLm1heExpbmVXaWR0aCA9IHRoaXMuc2l6ZSAvIDMwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBjYXNlICJzdGFyU2NhbGUiOgogICAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy5yZXNvbHV0aW9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2l6ZSA9IHRoaXMuY29uZmlnLnJlc29sdXRpb24gLyAoMTAgLyB2YWx1ZSk7CiAgICAgICAgICAgICAgICB0aGlzLm1heExpbmVXaWR0aCA9IHRoaXMuc2l6ZSAvIDMwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBjYXNlICJkZW5zaXR5IjoKICAgICAgICAgICAgICBjb25zdCBsZW4gPSBNYXRoLmNlaWwodmFsdWUgKiAxMDAwKTsKICAgICAgICAgICAgICBjb25zdCBkaWZmID0gbGVuIC0gdGhpcy5zdGFycy5sZW5ndGg7CiAgICAgICAgICAgICAgaWYgKGRpZmYgPiAwKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRpZmY7IGkrKykgewogICAgICAgICAgICAgICAgICB0aGlzLnN0YXJzLnB1c2goCiAgICAgICAgICAgICAgICAgICAgbmV3IFN0YXIoKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTAwMCwgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTAwMCwgMTAwMCAqIE1hdGgucmFuZG9tKCkpCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnMubGVuZ3RoID0gbGVuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBjYXNlICJzdGFyQ29sb3IiOgogICAgICAgICAgICAgIGlmICh2YWx1ZS5jaGFyQXQoMCkgPT09ICIjIiAmJiB2YWx1ZS5sZW5ndGggPT09IDcpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhclIgPSBwYXJzZUludCh2YWx1ZS5zdWJzdHIoMSwgMiksIDE2KTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhckcgPSBwYXJzZUludCh2YWx1ZS5zdWJzdHIoMywgMiksIDE2KTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhckIgPSBwYXJzZUludCh2YWx1ZS5zdWJzdHIoNSwgMiksIDE2KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuY29uZmlnW2tleV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBkcmF3KHRpbWVEZWx0YSkgewogICAgICB0aGlzLm1vdmUodGltZURlbHRhKTsKCiAgICAgIGNvbnN0IHdpZHRoID0gdGhpcy5jb25maWcucmVzb2x1dGlvbjsKICAgICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5jb25maWcucmVzb2x1dGlvbjsKICAgICAgdGhpcy5zaXplID0gTWF0aC5tYXgod2lkdGgsIGhlaWdodCkgLyAoMTAgLyB0aGlzLmNvbmZpZy5zdGFyU2NhbGUpOwoKICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmNvbmZpZy5iYWNrZ3JvdW5kQ29sb3I7CiAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKCiAgICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLnN0YXJzKSB7CiAgICAgICAgY29uc3QgeE9uRGlzcGxheSA9IHMueCAvIHMuejsKICAgICAgICBjb25zdCB5T25EaXNwbGF5ID0gcy55IC8gcy56OwoKICAgICAgICBpZiAoIXRoaXMuY29uZmlnLndhcnBFZmZlY3QgJiYgKHhPbkRpc3BsYXkgPCAtMC41IHx8IHhPbkRpc3BsYXkgPiAwLjUgfHwgeU9uRGlzcGxheSA8IC0wLjUgfHwgeU9uRGlzcGxheSA+IDAuNSkpCiAgICAgICAgICBjb250aW51ZQoKICAgICAgICBjb25zdCBzaXplID0gKHMuc2l6ZSAqIHRoaXMuc2l6ZSkgLyBzLno7CiAgICAgICAgaWYgKHNpemUgPCAwLjMpIGNvbnRpbnVlIC8vZG9uJ3QgZHJhdyB2ZXJ5IHNtYWxsIGRvdHMKCiAgICAgICAgaWYgKHRoaXMuY29uZmlnLmRlcHRoQWxwaGEpIHsKICAgICAgICAgIGNvbnN0IGFscGhhID0gKDEwMDAgLSBzLnopIC8gMTAwMDsKICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBgcmdiYSgke3RoaXMuc3RhclJ9LCR7dGhpcy5zdGFyR30sJHt0aGlzLnN0YXJCfSwke2FscGhhLnRvU3RyaW5nKCl9KWA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBgcmdiKCR7dGhpcy5zdGFyUn0sJHt0aGlzLnN0YXJHfSwke3RoaXMuc3RhckJ9KWA7IC8vcmdiCiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jb25maWcud2FycEVmZmVjdCkgewogICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgY29uc3QgeDJPbkRpc3BsYXkgPSBzLnggLyAocy56ICsgdGhpcy5jb25maWcud2FycEVmZmVjdExlbmd0aCAqIHRoaXMuc3BlZWQpOwogICAgICAgICAgY29uc3QgeTJPbkRpc3BsYXkgPSBzLnkgLyAocy56ICsgdGhpcy5jb25maWcud2FycEVmZmVjdExlbmd0aCAqIHRoaXMuc3BlZWQpOwoKICAgICAgICAgIGlmICh4Mk9uRGlzcGxheSA8IC0wLjUgfHwgeDJPbkRpc3BsYXkgPiAwLjUgfHwgeTJPbkRpc3BsYXkgPCAtMC41IHx8IHkyT25EaXNwbGF5ID4gMC41KSBjb250aW51ZQoKICAgICAgICAgIGN0eC5tb3ZlVG8od2lkdGggKiAoeE9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgaGVpZ2h0ICogKHlPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIpOwogICAgICAgICAgY3R4LmxpbmVUbyh3aWR0aCAqICh4Mk9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgaGVpZ2h0ICogKHkyT25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyKTsKICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBzaXplID4gdGhpcy5tYXhMaW5lV2lkdGggPyB0aGlzLm1heExpbmVXaWR0aCA6IHNpemU7CiAgICAgICAgICBjdHgubGluZUNhcCA9IHRoaXMuY29uZmlnLnVzZUNpcmNsZXMgPyAicm91bmQiIDogImJ1dHQiOwogICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gY3R4LmZpbGxTdHlsZTsKICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY29uZmlnLnVzZUNpcmNsZXMpIHsKICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgIGN0eC5hcmMod2lkdGggKiAoeE9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgaGVpZ2h0ICogKHlPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIHNpemUgLyAyLCAwLCAyICogTWF0aC5QSSk7CiAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdHguZmlsbFJlY3Qod2lkdGggKiAoeE9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgaGVpZ2h0ICogKHlPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIHNpemUsIHNpemUpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIG1vdmUodGltZURlbHRhKSB7CiAgICAgIGNvbnN0IHNwZWVkTXVsRiA9IHRpbWVEZWx0YSAvIDE2LjU7CiAgICAgIGNvbnN0IHNwZWVkQWRqRiA9IE1hdGgucG93KHRoaXMuY29uZmlnLnNwZWVkQWRqRmFjdG9yLCAxIC8gc3BlZWRNdWxGKTsKICAgICAgdGhpcy5zcGVlZCA9IHRoaXMuY29uZmlnLnRhcmdldFNwZWVkICogc3BlZWRBZGpGICsgdGhpcy5zcGVlZCAqICgxIC0gc3BlZWRBZGpGKTsKICAgICAgaWYgKHRoaXMuc3BlZWQgPCAwKSB0aGlzLnNwZWVkID0gMDsKICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnNwZWVkICogc3BlZWRNdWxGOwoKICAgICAgZm9yIChjb25zdCBzIG9mIHRoaXMuc3RhcnMpIHsKICAgICAgICBzLnogLT0gc3BlZWQ7CiAgICAgICAgd2hpbGUgKHMueiA8IDEpIHsKICAgICAgICAgIHMueiArPSAxMDAwOwogICAgICAgICAgcy54ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogcy56OwogICAgICAgICAgcy55ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogcy56OwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgbGV0IHdhcnBzcGVlZDsKICBsZXQgbGFzdFRpbWUgPSBudWxsOwoKICBjb25zdCB0aWNrID0gdGltZSA9PiB7CiAgICB3YXJwc3BlZWQuZHJhdyhsYXN0VGltZSA9PT0gbnVsbCA/IDEgOiB0aW1lIC0gbGFzdFRpbWUpOwogICAgbGFzdFRpbWUgPSB0aW1lOwogICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spOwogIH07CgogIG9ubWVzc2FnZSA9ICh7IGRhdGE6IHsgY2FudmFzLCBjb25maWcgfSB9KSA9PiB7CiAgICBpZiAoY2FudmFzICE9PSB1bmRlZmluZWQpIHsKICAgICAgbGFzdFRpbWUgPSBudWxsOwogICAgICB3YXJwc3BlZWQgPSBuZXcgV2FycFNwZWVkKGNhbnZhcyk7CiAgICB9CgogICAgaWYgKGNvbmZpZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHdhcnBzcGVlZC51cGRhdGUoY29uZmlnKTsKICAgICAgaWYgKGxhc3RUaW1lID09PSBudWxsKSB7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spOwogICAgICB9CiAgICB9CiAgfTsKCn0oKSk7Cgo=', 'data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLmpzIiwic291cmNlcyI6WyJ3b3JrZXI6L0M6XFx3ZWItd29ya2VyXFx3YXJwc3BlZWQuanMiLCJ3b3JrZXI6L0M6XFx3ZWItd29ya2VyXFx3b3JrZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNsYXNzIFN0YXIge1xuICBjb25zdHJ1Y3Rvcih4LCB5LCB6KSB7XG4gICAgdGhpcy54ID0geFxuICAgIHRoaXMueSA9IHlcbiAgICB0aGlzLnogPSB6XG4gICAgdGhpcy5zaXplID0gMC41ICsgTWF0aC5yYW5kb20oKVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdhcnBTcGVlZCB7XG5cbiAgY29uZmlnID0ge31cbiAgc3RhcnMgPSBbXVxuXG4gIHN0YXJSID0gMjU1XG4gIHN0YXJHID0gMjU1XG4gIHN0YXJCID0gMjU1XG5cbiAgY29uc3RydWN0b3IoY2FudmFzKSB7XG4gICAgdGhpcy5jYW52YXMgPSBjYW52YXNcbiAgICB0aGlzLmN0eCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoXCIyZFwiKVxuICB9XG5cbiAgdXBkYXRlKGNvbmZpZykge1xuICAgIC8vTGlsaUNvZGU6IG4gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2aiBuIG4gbiBuXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoY29uZmlnKSkge1xuICAgICAgLy8gY29uc29sZS5sb2coa2V5KVxuICAgICAgaWYgKHRoaXMuY29uZmlnW2tleV0gIT09IHZhbHVlKSB7XG4gICAgICAgIHN3aXRjaCAoa2V5KSB7XG4gICAgICAgICAgLy8gY2FzZSBcImJhY2tncm91bmRDb2xvclwiOlxuICAgICAgICAgIC8vICAgdGhpcy5jdHguZmlsbFN0eWxlID0gdGhpcy5jb25maWcuYmFja2dyb3VuZENvbG9yXG4gICAgICAgICAgLy8gICAvLyB0aGlzLmN0eC5maWxsUmVjdCgwLCAwLCB3aWR0aCwgaGVpZ2h0KVxuICAgICAgICAgIC8vICAgdGhpcy5jdHguZmlsbFJlY3QoMCwgMCwgNTEyLCA1MTIpXG4gICAgICAgICAgLy8gYnJlYWtcbiAgICAgICAgICBjYXNlIFwic3BlZWRcIjpcbiAgICAgICAgICBjYXNlIFwidGFyZ2V0U3BlZWRcIjpcbiAgICAgICAgICBjYXNlIFwic3BlZWRBZGpGYWN0b3JcIjpcbiAgICAgICAgICAgIHRoaXMuc3BlZWQgPSBrZXkgPT09IFwic3BlZWRcIiA/IHZhbHVlIDogdGhpcy5jb25maWcuc3BlZWQgfHwgMC43XG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIGNhc2UgXCJyZXNvbHV0aW9uXCI6XG4gICAgICAgICAgICBpZiAodGhpcy5jb25maWcuc3RhclNjYWxlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5zaXplID0gdmFsdWUgLyAoMTAgLyB0aGlzLmNvbmZpZy5zdGFyU2NhbGUpXG4gICAgICAgICAgICAgIHRoaXMubWF4TGluZVdpZHRoID0gdGhpcy5zaXplIC8gMzBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSBcInN0YXJTY2FsZVwiOlxuICAgICAgICAgICAgaWYgKHRoaXMuY29uZmlnLnJlc29sdXRpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICB0aGlzLnNpemUgPSB0aGlzLmNvbmZpZy5yZXNvbHV0aW9uIC8gKDEwIC8gdmFsdWUpXG4gICAgICAgICAgICAgIHRoaXMubWF4TGluZVdpZHRoID0gdGhpcy5zaXplIC8gMzBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSBcImRlbnNpdHlcIjpcbiAgICAgICAgICAgIGNvbnN0IGxlbiA9IE1hdGguY2VpbCh2YWx1ZSAqIDEwMDApXG4gICAgICAgICAgICBjb25zdCBkaWZmID0gbGVuIC0gdGhpcy5zdGFycy5sZW5ndGhcbiAgICAgICAgICAgIGlmIChkaWZmID4gMCkge1xuICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRpZmY7IGkrKykge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnMucHVzaChcbiAgICAgICAgICAgICAgICAgIG5ldyBTdGFyKChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwMDAsIChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDEwMDAsIDEwMDAgKiBNYXRoLnJhbmRvbSgpKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5zdGFycy5sZW5ndGggPSBsZW5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSBcInN0YXJDb2xvclwiOlxuICAgICAgICAgICAgaWYgKHZhbHVlLmNoYXJBdCgwKSA9PT0gXCIjXCIgJiYgdmFsdWUubGVuZ3RoID09PSA3KSB7XG4gICAgICAgICAgICAgIHRoaXMuc3RhclIgPSBwYXJzZUludCh2YWx1ZS5zdWJzdHIoMSwgMiksIDE2KVxuICAgICAgICAgICAgICB0aGlzLnN0YXJHID0gcGFyc2VJbnQodmFsdWUuc3Vic3RyKDMsIDIpLCAxNilcbiAgICAgICAgICAgICAgdGhpcy5zdGFyQiA9IHBhcnNlSW50KHZhbHVlLnN1YnN0cig1LCAyKSwgMTYpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBjb250aW51ZVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNvbmZpZ1trZXldID0gdmFsdWVcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBkcmF3KHRpbWVEZWx0YSkge1xuICAgIHRoaXMubW92ZSh0aW1lRGVsdGEpXG5cbiAgICBjb25zdCB3aWR0aCA9IHRoaXMuY29uZmlnLnJlc29sdXRpb25cbiAgICBjb25zdCBoZWlnaHQgPSB0aGlzLmNvbmZpZy5yZXNvbHV0aW9uXG4gICAgdGhpcy5zaXplID0gTWF0aC5tYXgod2lkdGgsIGhlaWdodCkgLyAoMTAgLyB0aGlzLmNvbmZpZy5zdGFyU2NhbGUpXG5cbiAgICBjb25zdCBjdHggPSB0aGlzLmN0eFxuICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmNvbmZpZy5iYWNrZ3JvdW5kQ29sb3JcbiAgICBjdHguZmlsbFJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodClcblxuICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLnN0YXJzKSB7XG4gICAgICBjb25zdCB4T25EaXNwbGF5ID0gcy54IC8gcy56XG4gICAgICBjb25zdCB5T25EaXNwbGF5ID0gcy55IC8gcy56XG5cbiAgICAgIGlmICghdGhpcy5jb25maWcud2FycEVmZmVjdCAmJiAoeE9uRGlzcGxheSA8IC0wLjUgfHwgeE9uRGlzcGxheSA+IDAuNSB8fCB5T25EaXNwbGF5IDwgLTAuNSB8fCB5T25EaXNwbGF5ID4gMC41KSlcbiAgICAgICAgY29udGludWVcblxuICAgICAgY29uc3Qgc2l6ZSA9IChzLnNpemUgKiB0aGlzLnNpemUpIC8gcy56XG4gICAgICBpZiAoc2l6ZSA8IDAuMykgY29udGludWUgLy9kb24ndCBkcmF3IHZlcnkgc21hbGwgZG90c1xuXG4gICAgICBpZiAodGhpcy5jb25maWcuZGVwdGhBbHBoYSkge1xuICAgICAgICBjb25zdCBhbHBoYSA9ICgxMDAwIC0gcy56KSAvIDEwMDBcbiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGByZ2JhKCR7dGhpcy5zdGFyUn0sJHt0aGlzLnN0YXJHfSwke3RoaXMuc3RhckJ9LCR7YWxwaGEudG9TdHJpbmcoKX0pYFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGByZ2IoJHt0aGlzLnN0YXJSfSwke3RoaXMuc3Rhckd9LCR7dGhpcy5zdGFyQn0pYCAvL3JnYlxuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5jb25maWcud2FycEVmZmVjdCkge1xuICAgICAgICBjdHguYmVnaW5QYXRoKClcbiAgICAgICAgY29uc3QgeDJPbkRpc3BsYXkgPSBzLnggLyAocy56ICsgdGhpcy5jb25maWcud2FycEVmZmVjdExlbmd0aCAqIHRoaXMuc3BlZWQpXG4gICAgICAgIGNvbnN0IHkyT25EaXNwbGF5ID0gcy55IC8gKHMueiArIHRoaXMuY29uZmlnLndhcnBFZmZlY3RMZW5ndGggKiB0aGlzLnNwZWVkKVxuXG4gICAgICAgIGlmICh4Mk9uRGlzcGxheSA8IC0wLjUgfHwgeDJPbkRpc3BsYXkgPiAwLjUgfHwgeTJPbkRpc3BsYXkgPCAtMC41IHx8IHkyT25EaXNwbGF5ID4gMC41KSBjb250aW51ZVxuXG4gICAgICAgIGN0eC5tb3ZlVG8od2lkdGggKiAoeE9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgaGVpZ2h0ICogKHlPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIpXG4gICAgICAgIGN0eC5saW5lVG8od2lkdGggKiAoeDJPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIGhlaWdodCAqICh5Mk9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMilcbiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IHNpemUgPiB0aGlzLm1heExpbmVXaWR0aCA/IHRoaXMubWF4TGluZVdpZHRoIDogc2l6ZVxuICAgICAgICBjdHgubGluZUNhcCA9IHRoaXMuY29uZmlnLnVzZUNpcmNsZXMgPyBcInJvdW5kXCIgOiBcImJ1dHRcIlxuICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBjdHguZmlsbFN0eWxlXG4gICAgICAgIGN0eC5zdHJva2UoKVxuICAgICAgfSBlbHNlIGlmICh0aGlzLmNvbmZpZy51c2VDaXJjbGVzKSB7XG4gICAgICAgIGN0eC5iZWdpblBhdGgoKVxuICAgICAgICBjdHguYXJjKHdpZHRoICogKHhPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIGhlaWdodCAqICh5T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBzaXplIC8gMiwgMCwgMiAqIE1hdGguUEkpXG4gICAgICAgIGN0eC5maWxsKClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGN0eC5maWxsUmVjdCh3aWR0aCAqICh4T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBoZWlnaHQgKiAoeU9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgc2l6ZSwgc2l6ZSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBtb3ZlKHRpbWVEZWx0YSkge1xuICAgIGNvbnN0IHNwZWVkTXVsRiA9IHRpbWVEZWx0YSAvIDE2LjVcbiAgICBjb25zdCBzcGVlZEFkakYgPSBNYXRoLnBvdyh0aGlzLmNvbmZpZy5zcGVlZEFkakZhY3RvciwgMSAvIHNwZWVkTXVsRilcbiAgICB0aGlzLnNwZWVkID0gdGhpcy5jb25maWcudGFyZ2V0U3BlZWQgKiBzcGVlZEFkakYgKyB0aGlzLnNwZWVkICogKDEgLSBzcGVlZEFkakYpXG4gICAgaWYgKHRoaXMuc3BlZWQgPCAwKSB0aGlzLnNwZWVkID0gMFxuICAgIGNvbnN0IHNwZWVkID0gdGhpcy5zcGVlZCAqIHNwZWVkTXVsRlxuXG4gICAgZm9yIChjb25zdCBzIG9mIHRoaXMuc3RhcnMpIHtcbiAgICAgIHMueiAtPSBzcGVlZFxuICAgICAgd2hpbGUgKHMueiA8IDEpIHtcbiAgICAgICAgcy56ICs9IDEwMDBcbiAgICAgICAgcy54ID0gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogcy56XG4gICAgICAgIHMueSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHMuelxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIiwiaW1wb3J0IFdhcnBTcGVlZCBmcm9tIFwiLi93YXJwc3BlZWRcIlxuXG5sZXQgd2FycHNwZWVkXG5sZXQgbGFzdFRpbWUgPSBudWxsXG5cbmNvbnN0IHRpY2sgPSB0aW1lID0+IHtcbiAgd2FycHNwZWVkLmRyYXcobGFzdFRpbWUgPT09IG51bGwgPyAxIDogdGltZSAtIGxhc3RUaW1lKVxuICBsYXN0VGltZSA9IHRpbWVcbiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spXG59XG5cbm9ubWVzc2FnZSA9ICh7IGRhdGE6IHsgY2FudmFzLCBjb25maWcgfSB9KSA9PiB7XG4gIGlmIChjYW52YXMgIT09IHVuZGVmaW5lZCkge1xuICAgIGxhc3RUaW1lID0gbnVsbFxuICAgIHdhcnBzcGVlZCA9IG5ldyBXYXJwU3BlZWQoY2FudmFzKVxuICB9XG5cbiAgaWYgKGNvbmZpZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgd2FycHNwZWVkLnVwZGF0ZShjb25maWcpXG4gICAgaWYgKGxhc3RUaW1lID09PSBudWxsKSB7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGljaylcbiAgICB9XG4gIH1cbn1cbiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7RUFBTyxNQUFNLElBQUksQ0FBQztFQUNsQixFQUFFLFdBQVcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRTtFQUN2QixJQUFJLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBQztFQUNkLElBQUksSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFDO0VBQ2QsSUFBSSxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUM7RUFDZCxJQUFJLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUU7RUFDbkMsR0FBRztFQUNILENBQUM7QUFDRDtFQUNlLE1BQU0sU0FBUyxDQUFDO0FBQy9CO0VBQ0EsRUFBRSxNQUFNLEdBQUcsRUFBRTtFQUNiLEVBQUUsS0FBSyxHQUFHLEVBQUU7QUFDWjtFQUNBLEVBQUUsS0FBSyxHQUFHLEdBQUc7RUFDYixFQUFFLEtBQUssR0FBRyxHQUFHO0VBQ2IsRUFBRSxLQUFLLEdBQUcsR0FBRztBQUNiO0VBQ0EsRUFBRSxXQUFXLENBQUMsTUFBTSxFQUFFO0VBQ3RCLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxPQUFNO0VBQ3hCLElBQUksSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUM7RUFDM0MsR0FBRztBQUNIO0VBQ0EsRUFBRSxNQUFNLENBQUMsTUFBTSxFQUFFO0VBQ2pCO0VBQ0EsSUFBSSxLQUFLLE1BQU0sQ0FBQyxHQUFH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', false);
/* eslint-enable */

AFRAME.registerComponent("warpspeed", {
  schema: {
    resolution: {
      type: "number",
      default: 512,
    },
    speed: {
      type: "number",
      default: 0.7,
    },
    targetSpeed: {
      type: "number",
      default: 0.7, // value of data.speed
    },
    speedAdjFactor: {
      type: "number",
      default: 0.03, // min: 0, max: 1
    },
    density: {
      type: "number",
      default: 0.7, // min: >0
    },
    useCircles: {
      type: "boolean",
      default: true,
    },
    depthAlpha: {
      type: "boolean",
      default: true,
    },
    warpEffect: {
      type: "boolean",
      default: true,
    },
    warpEffectLength: {
      type: "number",
      default: 5, // min: 0
    },
    starScale: {
      type: "number",
      default: 3, // min: >0
    },
    backgroundColor: {
      type: "color",
      default: "#100a1a",
    },
    starColor: {
      type: "color",
      default: "#ffffff",
    },
    useWorker: {
      type: "boolean",
      default: false
    }
  },

  update(oldData) {

    if (oldData.useWorker !== this.data.useWorker) {

      if (oldData.useWorker !== undefined) {
        if (oldData.useWorker) {
          this.worker.terminate();
          delete this.worker;
        } else {
          delete this.warpspeed;
        }
        this.canvasMap.dispose();
        delete this.canvas;
      }

      this.canvas = document.createElement("canvas");
      this.canvas.width = this.data.resolution;
      this.canvas.height = this.data.resolution;

      this.canvasMap = new THREE.Texture(this.canvas);
      this.el.getObject3D("mesh").material.map = this.canvasMap;

      if (this.data.useWorker) {
        const offscreen = this.canvas.transferControlToOffscreen();
        this.worker = new WorkerFactory();
        this.worker.postMessage({ canvas: offscreen }, [offscreen]);
      } else {
        this.warpspeed = new WarpSpeed(this.canvas);
      }
    }

    if (this.data.useWorker) {
      this.worker.postMessage({ config: this.data });
    } else {
      this.warpspeed.update(this.data);
    }
  },

  tick(_time, timeDelta) {
    if (!this.data.useWorker) {
      this.warpspeed.draw(timeDelta);
    }
    // this.material.map.needsUpdate = true
    this.canvasMap.needsUpdate = true;
  },
});
