const defaultRGB = {
  r: 255,
  g: 255,
  b: 255,
};

// detect

const isHex = color => color.charAt(0) === "#" && color.length === 7;
const isRGBA = color => color.startsWith("rgba");

// convert

// "rgba(44,44,44,1)"

const hex2rgb = color => ({
  r: parseInt(color.substr(1, 2), 16),
  g: parseInt(color.substr(3, 2), 16),
  b: parseInt(color.substr(5, 2), 16),
});

const rgba2rgb = color => {
  const [, r, g, b, a] = /^\s*rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)\s*$/.exec(color);
  return {
    r,
    g,
    b,
  }
};

const toRGB = color => {
  if (isHex(color)) {
    return hex2rgb(color)
  }
  if (isRGBA(color)) {
    return rgba2rgb(color)
  }

  return defaultRGB
};

const randPos = () => (Math.random() - 0.5) * 1000;

class Star {
  constructor(x, y, z) {
    this.x = x;
    this.y = y;
    this.z = z;
    this.size = 0.5 + Math.random();
  }
}

class WarpSpeed {
  config = {}
  stars = []

  constructor(canvas) {
    this.ctx = canvas.getContext("2d");
  }

  update(config) {
    //LiliCode: n vvvvvvvvvvvvvvvvvvj n n n n
    let resolutionUpdated = false;
    for (const [key, value] of Object.entries(config)) {
      if (this.config[key] !== value) {
        switch (key) {
          case "width":
          case "height":
          case "starScale":
            resolutionUpdated = true;
            break
          case "density":
            const starCount = Math.ceil(value * 1000);
            const diff = starCount - this.stars.length;
            if (diff > 0) {
              for (let i = 0; i < diff; i++) {
                const star = new Star(randPos(), randPos(), 1000 * Math.random());
                this.stars.push(star);
              }
            } else {
              this.stars.length = starCount;
            }
            break
          case "starColor":
            const color = toRGB(value);
            this.starR = color.r;
            this.starG = color.g;
            this.starB = color.b;
            break
        }
        this.config[key] = value;
      }
    }

    if (resolutionUpdated) {
      this.size = Math.max(this.config.width, this.config.height) / (10 / this.config.starScale);
      this.maxLineWidth = this.size / 30;
    }
  }

  draw(timeDelta) {
    this.move(timeDelta);

    const width = this.config.width;
    const height = this.config.height;
    this.size = Math.max(width, height) / (10 / this.config.starScale);

    const ctx = this.ctx;
    ctx.fillStyle = this.config.backgroundColor;
    ctx.fillRect(0, 0, width, height);

    for (const star of this.stars) {
      const xOnDisplay = star.x / star.z;
      const yOnDisplay = star.y / star.z;

      if (!this.config.warpEffect && (xOnDisplay < -0.5 || xOnDisplay > 0.5 || yOnDisplay < -0.5 || yOnDisplay > 0.5))
        continue

      const size = (star.size * this.size) / star.z;
      if (size < 0.3) continue //don't draw very small dots

      if (this.config.depthAlpha) {
        const alpha = (1000 - star.z) / 1000;
        ctx.fillStyle = `rgba(${this.starR}, ${this.starG}, ${this.starB}, ${alpha.toString()})`;
      } else {
        ctx.fillStyle = this.config.starColor;
      }

      if (this.config.warpEffect) {
        ctx.beginPath();
        const x2OnDisplay = star.x / (star.z + this.config.warpEffectLength * this.config.speed);
        const y2OnDisplay = star.y / (star.z + this.config.warpEffectLength * this.config.speed);

        if (x2OnDisplay < -0.5 || x2OnDisplay > 0.5 || y2OnDisplay < -0.5 || y2OnDisplay > 0.5) continue

        ctx.moveTo(width * (xOnDisplay + 0.5) - size / 2, height * (yOnDisplay + 0.5) - size / 2);
        ctx.lineTo(width * (x2OnDisplay + 0.5) - size / 2, height * (y2OnDisplay + 0.5) - size / 2);
        ctx.lineWidth = Math.min(size, this.maxLineWidth);
        ctx.lineCap = this.config.useCircles ? "round" : "butt";
        ctx.strokeStyle = ctx.fillStyle;
        ctx.stroke();
      } else if (this.config.useCircles) {
        ctx.beginPath();
        ctx.arc(width * (xOnDisplay + 0.5) - size / 2, height * (yOnDisplay + 0.5) - size / 2, size / 2, 0, 2 * Math.PI);
        ctx.fill();
      } else {
        ctx.fillRect(width * (xOnDisplay + 0.5) - size / 2, height * (yOnDisplay + 0.5) - size / 2, size, size);
      }
    }
  }

  move(timeDelta) {
    const speed = this.config.speed * (timeDelta / 10);

    for (const star of this.stars) {
      star.z -= speed;
      while (star.z < 1) {
        star.z += 1000;
        star.x = (Math.random() - 0.5) * star.z;
        star.y = (Math.random() - 0.5) * star.z;
      }
    }
  }
}

function decodeBase64(base64, enableUnicode) {
    var binaryString = atob(base64);
    if (enableUnicode) {
        var binaryView = new Uint8Array(binaryString.length);
        for (var i = 0, n = binaryString.length; i < n; ++i) {
            binaryView[i] = binaryString.charCodeAt(i);
        }
        return String.fromCharCode.apply(null, new Uint16Array(binaryView.buffer));
    }
    return binaryString;
}

function createURL(base64, sourcemapArg, enableUnicodeArg) {
    var sourcemap = sourcemapArg === undefined ? null : sourcemapArg;
    var enableUnicode = enableUnicodeArg === undefined ? false : enableUnicodeArg;
    var source = decodeBase64(base64, enableUnicode);
    var start = source.indexOf('\n', 10) + 1;
    var body = source.substring(start) + (sourcemap ? '\/\/# sourceMappingURL=' + sourcemap : '');
    var blob = new Blob([body], { type: 'application/javascript' });
    return URL.createObjectURL(blob);
}

function createBase64WorkerFactory(base64, sourcemapArg, enableUnicodeArg) {
    var url;
    return function WorkerFactory(options) {
        url = url || createURL(base64, sourcemapArg, enableUnicodeArg);
        return new Worker(url, options);
    };
}

var WorkerFactory = createBase64WorkerFactory('Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgY29uc3QgZGVmYXVsdFJHQiA9IHsKICAgIHI6IDI1NSwKICAgIGc6IDI1NSwKICAgIGI6IDI1NSwKICB9OwoKICAvLyBkZXRlY3QKCiAgY29uc3QgaXNIZXggPSBjb2xvciA9PiBjb2xvci5jaGFyQXQoMCkgPT09ICIjIiAmJiBjb2xvci5sZW5ndGggPT09IDc7CiAgY29uc3QgaXNSR0JBID0gY29sb3IgPT4gY29sb3Iuc3RhcnRzV2l0aCgicmdiYSIpOwoKICAvLyBjb252ZXJ0CgogIC8vICJyZ2JhKDQ0LDQ0LDQ0LDEpIgoKICBjb25zdCBoZXgycmdiID0gY29sb3IgPT4gKHsKICAgIHI6IHBhcnNlSW50KGNvbG9yLnN1YnN0cigxLCAyKSwgMTYpLAogICAgZzogcGFyc2VJbnQoY29sb3Iuc3Vic3RyKDMsIDIpLCAxNiksCiAgICBiOiBwYXJzZUludChjb2xvci5zdWJzdHIoNSwgMiksIDE2KSwKICB9KTsKCiAgY29uc3QgcmdiYTJyZ2IgPSBjb2xvciA9PiB7CiAgICBjb25zdCBbLCByLCBnLCBiLCBhXSA9IC9eXHMqcmdiYVxzKlwoXHMqKFxkKylccyosXHMqKFxkKylccyosXHMqKFxkKylccyosXHMqKFxkKylccypcKVxzKiQvLmV4ZWMoY29sb3IpOwogICAgcmV0dXJuIHsKICAgICAgciwKICAgICAgZywKICAgICAgYiwKICAgIH0KICB9OwoKICBjb25zdCB0b1JHQiA9IGNvbG9yID0+IHsKICAgIGlmIChpc0hleChjb2xvcikpIHsKICAgICAgcmV0dXJuIGhleDJyZ2IoY29sb3IpCiAgICB9CiAgICBpZiAoaXNSR0JBKGNvbG9yKSkgewogICAgICByZXR1cm4gcmdiYTJyZ2IoY29sb3IpCiAgICB9CgogICAgcmV0dXJuIGRlZmF1bHRSR0IKICB9OwoKICBjb25zdCByYW5kUG9zID0gKCkgPT4gKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMTAwMDsKCiAgY2xhc3MgU3RhciB7CiAgICBjb25zdHJ1Y3Rvcih4LCB5LCB6KSB7CiAgICAgIHRoaXMueCA9IHg7CiAgICAgIHRoaXMueSA9IHk7CiAgICAgIHRoaXMueiA9IHo7CiAgICAgIHRoaXMuc2l6ZSA9IDAuNSArIE1hdGgucmFuZG9tKCk7CiAgICB9CiAgfQoKICBjbGFzcyBXYXJwU3BlZWQgewogICAgY29uZmlnID0ge30KICAgIHN0YXJzID0gW10KCiAgICBjb25zdHJ1Y3RvcihjYW52YXMpIHsKICAgICAgdGhpcy5jdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgIH0KCiAgICB1cGRhdGUoY29uZmlnKSB7CiAgICAgIC8vTGlsaUNvZGU6IG4gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2aiBuIG4gbiBuCiAgICAgIGxldCByZXNvbHV0aW9uVXBkYXRlZCA9IGZhbHNlOwogICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhjb25maWcpKSB7CiAgICAgICAgaWYgKHRoaXMuY29uZmlnW2tleV0gIT09IHZhbHVlKSB7CiAgICAgICAgICBzd2l0Y2ggKGtleSkgewogICAgICAgICAgICBjYXNlICJ3aWR0aCI6CiAgICAgICAgICAgIGNhc2UgImhlaWdodCI6CiAgICAgICAgICAgIGNhc2UgInN0YXJTY2FsZSI6CiAgICAgICAgICAgICAgcmVzb2x1dGlvblVwZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGNhc2UgImRlbnNpdHkiOgogICAgICAgICAgICAgIGNvbnN0IHN0YXJDb3VudCA9IE1hdGguY2VpbCh2YWx1ZSAqIDEwMDApOwogICAgICAgICAgICAgIGNvbnN0IGRpZmYgPSBzdGFyQ291bnQgLSB0aGlzLnN0YXJzLmxlbmd0aDsKICAgICAgICAgICAgICBpZiAoZGlmZiA+IDApIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGlmZjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXIgPSBuZXcgU3RhcihyYW5kUG9zKCksIHJhbmRQb3MoKSwgMTAwMCAqIE1hdGgucmFuZG9tKCkpOwogICAgICAgICAgICAgICAgICB0aGlzLnN0YXJzLnB1c2goc3Rhcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnMubGVuZ3RoID0gc3RhckNvdW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBjYXNlICJzdGFyQ29sb3IiOgogICAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gdG9SR0IodmFsdWUpOwogICAgICAgICAgICAgIHRoaXMuc3RhclIgPSBjb2xvci5yOwogICAgICAgICAgICAgIHRoaXMuc3RhckcgPSBjb2xvci5nOwogICAgICAgICAgICAgIHRoaXMuc3RhckIgPSBjb2xvci5iOwogICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmNvbmZpZ1trZXldID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocmVzb2x1dGlvblVwZGF0ZWQpIHsKICAgICAgICB0aGlzLnNpemUgPSBNYXRoLm1heCh0aGlzLmNvbmZpZy53aWR0aCwgdGhpcy5jb25maWcuaGVpZ2h0KSAvICgxMCAvIHRoaXMuY29uZmlnLnN0YXJTY2FsZSk7CiAgICAgICAgdGhpcy5tYXhMaW5lV2lkdGggPSB0aGlzLnNpemUgLyAzMDsKICAgICAgfQogICAgfQoKICAgIGRyYXcodGltZURlbHRhKSB7CiAgICAgIHRoaXMubW92ZSh0aW1lRGVsdGEpOwoKICAgICAgY29uc3Qgd2lkdGggPSB0aGlzLmNvbmZpZy53aWR0aDsKICAgICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5jb25maWcuaGVpZ2h0OwogICAgICB0aGlzLnNpemUgPSBNYXRoLm1heCh3aWR0aCwgaGVpZ2h0KSAvICgxMCAvIHRoaXMuY29uZmlnLnN0YXJTY2FsZSk7CgogICAgICBjb25zdCBjdHggPSB0aGlzLmN0eDsKICAgICAgY3R4LmZpbGxTdHlsZSA9IHRoaXMuY29uZmlnLmJhY2tncm91bmRDb2xvcjsKICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIHdpZHRoLCBoZWlnaHQpOwoKICAgICAgZm9yIChjb25zdCBzdGFyIG9mIHRoaXMuc3RhcnMpIHsKICAgICAgICBjb25zdCB4T25EaXNwbGF5ID0gc3Rhci54IC8gc3Rhci56OwogICAgICAgIGNvbnN0IHlPbkRpc3BsYXkgPSBzdGFyLnkgLyBzdGFyLno7CgogICAgICAgIGlmICghdGhpcy5jb25maWcud2FycEVmZmVjdCAmJiAoeE9uRGlzcGxheSA8IC0wLjUgfHwgeE9uRGlzcGxheSA+IDAuNSB8fCB5T25EaXNwbGF5IDwgLTAuNSB8fCB5T25EaXNwbGF5ID4gMC41KSkKICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGNvbnN0IHNpemUgPSAoc3Rhci5zaXplICogdGhpcy5zaXplKSAvIHN0YXIuejsKICAgICAgICBpZiAoc2l6ZSA8IDAuMykgY29udGludWUgLy9kb24ndCBkcmF3IHZlcnkgc21hbGwgZG90cwoKICAgICAgICBpZiAodGhpcy5jb25maWcuZGVwdGhBbHBoYSkgewogICAgICAgICAgY29uc3QgYWxwaGEgPSAoMTAwMCAtIHN0YXIueikgLyAxMDAwOwogICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGByZ2JhKCR7dGhpcy5zdGFyUn0sICR7dGhpcy5zdGFyR30sICR7dGhpcy5zdGFyQn0sICR7YWxwaGEudG9TdHJpbmcoKX0pYDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IHRoaXMuY29uZmlnLnN0YXJDb2xvcjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNvbmZpZy53YXJwRWZmZWN0KSB7CiAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICBjb25zdCB4Mk9uRGlzcGxheSA9IHN0YXIueCAvIChzdGFyLnogKyB0aGlzLmNvbmZpZy53YXJwRWZmZWN0TGVuZ3RoICogdGhpcy5jb25maWcuc3BlZWQpOwogICAgICAgICAgY29uc3QgeTJPbkRpc3BsYXkgPSBzdGFyLnkgLyAoc3Rhci56ICsgdGhpcy5jb25maWcud2FycEVmZmVjdExlbmd0aCAqIHRoaXMuY29uZmlnLnNwZWVkKTsKCiAgICAgICAgICBpZiAoeDJPbkRpc3BsYXkgPCAtMC41IHx8IHgyT25EaXNwbGF5ID4gMC41IHx8IHkyT25EaXNwbGF5IDwgLTAuNSB8fCB5Mk9uRGlzcGxheSA+IDAuNSkgY29udGludWUKCiAgICAgICAgICBjdHgubW92ZVRvKHdpZHRoICogKHhPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIGhlaWdodCAqICh5T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyKTsKICAgICAgICAgIGN0eC5saW5lVG8od2lkdGggKiAoeDJPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIGhlaWdodCAqICh5Mk9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMik7CiAgICAgICAgICBjdHgubGluZVdpZHRoID0gTWF0aC5taW4oc2l6ZSwgdGhpcy5tYXhMaW5lV2lkdGgpOwogICAgICAgICAgY3R4LmxpbmVDYXAgPSB0aGlzLmNvbmZpZy51c2VDaXJjbGVzID8gInJvdW5kIiA6ICJidXR0IjsKICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGN0eC5maWxsU3R5bGU7CiAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmNvbmZpZy51c2VDaXJjbGVzKSB7CiAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICBjdHguYXJjKHdpZHRoICogKHhPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIGhlaWdodCAqICh5T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBzaXplIC8gMiwgMCwgMiAqIE1hdGguUEkpOwogICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3R4LmZpbGxSZWN0KHdpZHRoICogKHhPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIGhlaWdodCAqICh5T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBzaXplLCBzaXplKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBtb3ZlKHRpbWVEZWx0YSkgewogICAgICBjb25zdCBzcGVlZCA9IHRoaXMuY29uZmlnLnNwZWVkICogKHRpbWVEZWx0YSAvIDEwKTsKCiAgICAgIGZvciAoY29uc3Qgc3RhciBvZiB0aGlzLnN0YXJzKSB7CiAgICAgICAgc3Rhci56IC09IHNwZWVkOwogICAgICAgIHdoaWxlIChzdGFyLnogPCAxKSB7CiAgICAgICAgICBzdGFyLnogKz0gMTAwMDsKICAgICAgICAgIHN0YXIueCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHN0YXIuejsKICAgICAgICAgIHN0YXIueSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHN0YXIuejsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGxldCB3YXJwc3BlZWQ7CiAgbGV0IGxhc3RUaW1lOwogIGxldCBwYXVzZWQ7CgogIGNvbnN0IHRpY2sgPSB0aW1lID0+IHsKICAgIGlmIChwYXVzZWQpIHJldHVybgogICAgd2FycHNwZWVkLmRyYXcobGFzdFRpbWUgPT09IG51bGwgPyAxIDogdGltZSAtIGxhc3RUaW1lKTsKICAgIGxhc3RUaW1lID0gdGltZTsKICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKTsKICB9OwoKICBvbm1lc3NhZ2UgPSAoeyBkYXRhOiB7IGNhbnZhcywgY29uZmlnLCBwYXVzZSB9IH0pID0+IHsKICAgIGlmIChjYW52YXMgIT09IHVuZGVmaW5lZCkgewogICAgICB3YXJwc3BlZWQgPSBuZXcgV2FycFNwZWVkKGNhbnZhcyk7CiAgICB9CgogICAgaWYgKGNvbmZpZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHdhcnBzcGVlZC51cGRhdGUoY29uZmlnKTsKICAgIH0KCiAgICBpZiAocGF1c2UgIT09IHVuZGVmaW5lZCkgewogICAgICBwYXVzZWQgPSBwYXVzZTsKICAgICAgaWYgKCFwYXVzZWQpIHsKICAgICAgICBsYXN0VGltZSA9IG51bGw7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spOwogICAgICB9CiAgICB9CiAgfTsKCn0oKSk7Cgo=', 'data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLmpzIiwic291cmNlcyI6WyJ3b3JrZXI6L0M6XFx3ZWItd29ya2VyXFxjb2xvcmZ0LmpzIiwid29ya2VyOi9DOlxcd2ViLXdvcmtlclxcd2FycHNwZWVkLmpzIiwid29ya2VyOi9DOlxcd2ViLXdvcmtlclxcd29ya2VyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGRlZmF1bHRSR0IgPSB7XG4gIHI6IDI1NSxcbiAgZzogMjU1LFxuICBiOiAyNTUsXG59XG5cbi8vIGRldGVjdFxuXG5jb25zdCBpc0hleCA9IGNvbG9yID0+IGNvbG9yLmNoYXJBdCgwKSA9PT0gXCIjXCIgJiYgY29sb3IubGVuZ3RoID09PSA3XG5jb25zdCBpc1JHQkEgPSBjb2xvciA9PiBjb2xvci5zdGFydHNXaXRoKFwicmdiYVwiKVxuXG4vLyBjb252ZXJ0XG5cbi8vIFwicmdiYSg0NCw0NCw0NCwxKVwiXG5cbmNvbnN0IGhleDJyZ2IgPSBjb2xvciA9PiAoe1xuICByOiBwYXJzZUludChjb2xvci5zdWJzdHIoMSwgMiksIDE2KSxcbiAgZzogcGFyc2VJbnQoY29sb3Iuc3Vic3RyKDMsIDIpLCAxNiksXG4gIGI6IHBhcnNlSW50KGNvbG9yLnN1YnN0cig1LCAyKSwgMTYpLFxufSlcblxuY29uc3QgcmdiYTJyZ2IgPSBjb2xvciA9PiB7XG4gIGNvbnN0IFssIHIsIGcsIGIsIGFdID0gL15cXHMqcmdiYVxccypcXChcXHMqKFxcZCspXFxzKixcXHMqKFxcZCspXFxzKixcXHMqKFxcZCspXFxzKixcXHMqKFxcZCspXFxzKlxcKVxccyokLy5leGVjKGNvbG9yKVxuICByZXR1cm4ge1xuICAgIHIsXG4gICAgZyxcbiAgICBiLFxuICB9XG59XG5cbmV4cG9ydCBjb25zdCB0b1JHQiA9IGNvbG9yID0+IHtcbiAgaWYgKGlzSGV4KGNvbG9yKSkge1xuICAgIHJldHVybiBoZXgycmdiKGNvbG9yKVxuICB9XG4gIGlmIChpc1JHQkEoY29sb3IpKSB7XG4gICAgcmV0dXJuIHJnYmEycmdiKGNvbG9yKVxuICB9XG5cbiAgcmV0dXJuIGRlZmF1bHRSR0Jcbn1cbiIsImltcG9ydCB7IHRvUkdCIH0gZnJvbSBcIi4vY29sb3JmdFwiXG5cbmNvbnN0IHJhbmRQb3MgPSAoKSA9PiAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAxMDAwXG5cbmNsYXNzIFN0YXIge1xuICBjb25zdHJ1Y3Rvcih4LCB5LCB6KSB7XG4gICAgdGhpcy54ID0geFxuICAgIHRoaXMueSA9IHlcbiAgICB0aGlzLnogPSB6XG4gICAgdGhpcy5zaXplID0gMC41ICsgTWF0aC5yYW5kb20oKVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdhcnBTcGVlZCB7XG4gIGNvbmZpZyA9IHt9XG4gIHN0YXJzID0gW11cblxuICBjb25zdHJ1Y3RvcihjYW52YXMpIHtcbiAgICB0aGlzLmN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIilcbiAgfVxuXG4gIHVwZGF0ZShjb25maWcpIHtcbiAgICAvL0xpbGlDb2RlOiBuIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dmogbiBuIG4gblxuICAgIGxldCByZXNvbHV0aW9uVXBkYXRlZCA9IGZhbHNlXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoY29uZmlnKSkge1xuICAgICAgaWYgKHRoaXMuY29uZmlnW2tleV0gIT09IHZhbHVlKSB7XG4gICAgICAgIHN3aXRjaCAoa2V5KSB7XG4gICAgICAgICAgY2FzZSBcIndpZHRoXCI6XG4gICAgICAgICAgY2FzZSBcImhlaWdodFwiOlxuICAgICAgICAgIGNhc2UgXCJzdGFyU2NhbGVcIjpcbiAgICAgICAgICAgIHJlc29sdXRpb25VcGRhdGVkID0gdHJ1ZVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICBjYXNlIFwiZGVuc2l0eVwiOlxuICAgICAgICAgICAgY29uc3Qgc3RhckNvdW50ID0gTWF0aC5jZWlsKHZhbHVlICogMTAwMClcbiAgICAgICAgICAgIGNvbnN0IGRpZmYgPSBzdGFyQ291bnQgLSB0aGlzLnN0YXJzLmxlbmd0aFxuICAgICAgICAgICAgaWYgKGRpZmYgPiAwKSB7XG4gICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGlmZjsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3RhciA9IG5ldyBTdGFyKHJhbmRQb3MoKSwgcmFuZFBvcygpLCAxMDAwICogTWF0aC5yYW5kb20oKSlcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXJzLnB1c2goc3RhcilcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5zdGFycy5sZW5ndGggPSBzdGFyQ291bnRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSBcInN0YXJDb2xvclwiOlxuICAgICAgICAgICAgY29uc3QgY29sb3IgPSB0b1JHQih2YWx1ZSlcbiAgICAgICAgICAgIHRoaXMuc3RhclIgPSBjb2xvci5yXG4gICAgICAgICAgICB0aGlzLnN0YXJHID0gY29sb3IuZ1xuICAgICAgICAgICAgdGhpcy5zdGFyQiA9IGNvbG9yLmJcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb25maWdba2V5XSA9IHZhbHVlXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHJlc29sdXRpb25VcGRhdGVkKSB7XG4gICAgICB0aGlzLnNpemUgPSBNYXRoLm1heCh0aGlzLmNvbmZpZy53aWR0aCwgdGhpcy5jb25maWcuaGVpZ2h0KSAvICgxMCAvIHRoaXMuY29uZmlnLnN0YXJTY2FsZSlcbiAgICAgIHRoaXMubWF4TGluZVdpZHRoID0gdGhpcy5zaXplIC8gMzBcbiAgICB9XG4gIH1cblxuICBkcmF3KHRpbWVEZWx0YSkge1xuICAgIHRoaXMubW92ZSh0aW1lRGVsdGEpXG5cbiAgICBjb25zdCB3aWR0aCA9IHRoaXMuY29uZmlnLndpZHRoXG4gICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5jb25maWcuaGVpZ2h0XG4gICAgdGhpcy5zaXplID0gTWF0aC5tYXgod2lkdGgsIGhlaWdodCkgLyAoMTAgLyB0aGlzLmNvbmZpZy5zdGFyU2NhbGUpXG5cbiAgICBjb25zdCBjdHggPSB0aGlzLmN0eFxuICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmNvbmZpZy5iYWNrZ3JvdW5kQ29sb3JcbiAgICBjdHguZmlsbFJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodClcblxuICAgIGZvciAoY29uc3Qgc3RhciBvZiB0aGlzLnN0YXJzKSB7XG4gICAgICBjb25zdCB4T25EaXNwbGF5ID0gc3Rhci54IC8gc3Rhci56XG4gICAgICBjb25zdCB5T25EaXNwbGF5ID0gc3Rhci55IC8gc3Rhci56XG5cbiAgICAgIGlmICghdGhpcy5jb25maWcud2FycEVmZmVjdCAmJiAoeE9uRGlzcGxheSA8IC0wLjUgfHwgeE9uRGlzcGxheSA+IDAuNSB8fCB5T25EaXNwbGF5IDwgLTAuNSB8fCB5T25EaXNwbGF5ID4gMC41KSlcbiAgICAgICAgY29udGludWVcblxuICAgICAgY29uc3Qgc2l6ZSA9IChzdGFyLnNpemUgKiB0aGlzLnNpemUpIC8gc3Rhci56XG4gICAgICBpZiAoc2l6ZSA8IDAuMykgY29udGludWUgLy9kb24ndCBkcmF3IHZlcnkgc21hbGwgZG90c1xuXG4gICAgICBpZiAodGhpcy5jb25maWcuZGVwdGhBbHBoYSkge1xuICAgICAgICBjb25zdCBhbHBoYSA9ICgxMDAwIC0gc3Rhci56KSAvIDEwMDBcbiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGByZ2JhKCR7dGhpcy5zdGFyUn0sICR7dGhpcy5zdGFyR30sICR7dGhpcy5zdGFyQn0sICR7YWxwaGEudG9TdHJpbmcoKX0pYFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IHRoaXMuY29uZmlnLnN0YXJDb2xvclxuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5jb25maWcud2FycEVmZmVjdCkge1xuICAgICAgICBjdHguYmVnaW5QYXRoKClcbiAgICAgICAgY29uc3QgeDJPbkRpc3BsYXkgPSBzdGFyLnggLyAoc3Rhci56ICsgdGhpcy5jb25maWcud2FycEVmZmVjdExlbmd0aCAqIHRoaXMuY29uZmlnLnNwZWVkKVxuICAgICAgICBjb25zdCB5Mk9uRGlzcGxheSA9IHN0YXIueSAvIChzdGFyLnogKyB0aGlzLmNvbmZpZy53YXJwRWZmZWN0TGVuZ3RoICogdGhpcy5jb25maWcuc3BlZWQpXG5cbiAgICAgICAgaWYgKHgyT25EaXNwbGF5IDwgLTAuNSB8fCB4Mk9uRGlzcGxheSA+IDAuNSB8fCB5Mk9uRGlzcGxheSA8IC0wLjUgfHwgeTJPbkRpc3BsYXkgPiAwLjUpIGNvbnRpbnVlXG5cbiAgICAgICAgY3R4Lm1vdmVUbyh3aWR0aCAqICh4T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBoZWlnaHQgKiAoeU9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMilcbiAgICAgICAgY3R4LmxpbmVUbyh3aWR0aCAqICh4Mk9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgaGVpZ2h0ICogKHkyT25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyKVxuICAgICAgICBjdHgubGluZVdpZHRoID0gTWF0aC5taW4oc2l6ZSwgdGhpcy5tYXhMaW5lV2lkdGgpXG4gICAgICAgIGN0eC5saW5lQ2FwID0gdGhpcy5jb25maWcudXNlQ2lyY2xlcyA/IFwicm91bmRcIiA6IFwiYnV0dFwiXG4gICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGN0eC5maWxsU3R5bGVcbiAgICAgICAgY3R4LnN0cm9rZSgpXG4gICAgICB9IGVsc2UgaWYgKHRoaXMuY29uZmlnLnVzZUNpcmNsZXMpIHtcbiAgICAgICAgY3R4LmJlZ2luUGF0aCgpXG4gICAgICAgIGN0eC5hcmMod2lkdGggKiAoeE9uRGlzcGxheSArIDAuNSkgLSBzaXplIC8gMiwgaGVpZ2h0ICogKHlPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIHNpemUgLyAyLCAwLCAyICogTWF0aC5QSSlcbiAgICAgICAgY3R4LmZpbGwoKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY3R4LmZpbGxSZWN0KHdpZHRoICogKHhPbkRpc3BsYXkgKyAwLjUpIC0gc2l6ZSAvIDIsIGhlaWdodCAqICh5T25EaXNwbGF5ICsgMC41KSAtIHNpemUgLyAyLCBzaXplLCBzaXplKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG1vdmUodGltZURlbHRhKSB7XG4gICAgY29uc3Qgc3BlZWQgPSB0aGlzLmNvbmZpZy5zcGVlZCAqICh0aW1lRGVsdGEgLyAxMClcblxuICAgIGZvciAoY29uc3Qgc3RhciBvZiB0aGlzLnN0YXJzKSB7XG4gICAgICBzdGFyLnogLT0gc3BlZWRcbiAgICAgIHdoaWxlIChzdGFyLnogPCAxKSB7XG4gICAgICAgIHN0YXIueiArPSAxMDAwXG4gICAgICAgIHN0YXIueCA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIHN0YXIuelxuICAgICAgICBzdGFyLnkgPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiBzdGFyLnpcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiIsImltcG9ydCBXYXJwU3BlZWQgZnJvbSBcIi4vd2FycHNwZWVkXCJcblxubGV0IHdhcnBzcGVlZFxubGV0IGxhc3RUaW1lXG5sZXQgcGF1c2VkXG5cbmNvbnN0IHRpY2sgPSB0aW1lID0+IHtcbiAgaWYgKHBhdXNlZCkgcmV0dXJuXG4gIHdhcnBzcGVlZC5kcmF3KGxhc3RUaW1lID09PSBudWxsID8gMSA6IHRpbWUgLSBsYXN0VGltZSlcbiAgbGFzdFRpbWUgPSB0aW1lXG4gIHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKVxufVxuXG5vbm1lc3NhZ2UgPSAoeyBkYXRhOiB7IGNhbnZhcywgY29uZmlnLCBwYXVzZSB9IH0pID0+IHtcbiAgaWYgKGNhbnZhcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgd2FycHNwZWVkID0gbmV3IFdhcnBTcGVlZChjYW52YXMpXG4gIH1cblxuICBpZiAoY29uZmlnICE9PSB1bmRlZmluZWQpIHtcbiAgICB3YXJwc3BlZWQudXBkYXRlKGNvbmZpZylcbiAgfVxuXG4gIGlmIChwYXVzZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgcGF1c2VkID0gcGF1c2VcbiAgICBpZiAoIXBhdXNlZCkge1xuICAgICAgbGFzdFRpbWUgPSBudWxsXG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGljaylcbiAgICB9XG4gIH1cbn1cbiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7RUFBQSxNQUFNLFVBQVUsR0FBRztFQUNuQixFQUFFLENBQUMsRUFBRSxHQUFHO0VBQ1IsRUFBRSxDQUFDLEVBQUUsR0FBRztFQUNSLEVBQUUsQ0FBQyxFQUFFLEdBQUc7RUFDUixFQUFDO0FBQ0Q7RUFDQTtBQUNBO0VBQ0EsTUFBTSxLQUFLLEdBQUcsS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssRUFBQztFQUNwRSxNQUFNLE1BQU0sR0FBRyxLQUFLLElBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUM7QUFDaEQ7RUFDQTtBQUNBO0VBQ0E7QUFDQTtFQUNBLE1BQU0sT0FBTyxHQUFHLEtBQUssS0FBSztFQUMxQixFQUFFLENBQUMsRUFBRSxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDO0VBQ3JDLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7RUFDckMsRUFBRSxDQUFDLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQztFQUNyQyxDQUFDLEVBQUM7QUFDRjtFQUNBLE1BQU0sUUFBUSxHQUFHLEtBQUssSUFBSTtFQUMxQixFQUFFLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxvRUFBb0Us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LENBQUMsZ0JBQWU7RUFDL0MsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBQztBQUNyQztFQUNBLElBQUksS0FBSyxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO0VBQ25DLE1BQU0sTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBQztFQUN4QyxNQUFNLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUM7QUFDeEM7RUFDQSxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsS0FBSyxVQUFVLEdBQUcsQ0FBQyxHQUFHLElBQUksVUFBVSxHQUFHLEdBQUcsSUFBSSxVQUFVLEdBQUcsQ0FBQyxHQUFHLElBQUksVUFBVSxHQUFHLEdBQUcsQ0FBQztFQUNySCxRQUFRLFFBQVE7QUFDaEI7RUFDQSxNQUFNLE1BQU0sSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxFQUFDO0VBQ25ELE1BQU0sSUFBSSxJQUFJLEdBQUcsR0FBRyxFQUFFLFFBQVE7QUFDOUI7RUFDQSxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUU7RUFDbEMsUUFBUSxNQUFNLEtBQUssR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxJQUFJLEtBQUk7RUFDNUMsUUFBUSxHQUFHLENBQUMsU0FBUyxHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLEVBQUM7RUFDaEcsT0FBTyxNQUFNO0VBQ2IsUUFBUSxHQUFHLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxN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', false);
/* eslint-enable */

AFRAME.registerComponent("warpspeed", {
  schema: {
    width: {
      type: "number",
      default: 512,
    },
    height: {
      type: "number",
      default: 512,
    },
    speed: {
      type: "number",
      default: 0.7,
    },
    density: {
      type: "number",
      // default: 0.7, // min: >0
      default: 25.7, // min: >0
    },
    useCircles: {
      type: "boolean",
      default: true,
    },
    depthAlpha: {
      type: "boolean",
      default: true,
    },
    warpEffect: {
      type: "boolean",
      default: true,
    },
    warpEffectLength: {
      type: "number",
      default: 5, // min: 0
    },
    starScale: {
      type: "number",
      default: 3, // min: >0
    },
    backgroundColor: {
      type: "color",
      default: "#100a1a",
    },
    starColor: {
      type: "color",
      default: "#ffffff",
    },
    useWorker: {
      type: "boolean",
      default: false,
    },
  },

  update(oldData) {
    const reloadTexture =
      oldData.useWorker !== this.data.useWorker ||
      oldData.width !== this.data.width ||
      oldData.height !== this.data.height;

    if (reloadTexture) {
      if (oldData.useWorker !== undefined) {
        this.destroyCanvasMap();
      }
      this.createCanvasMap();
      this.initWarpspeed();
    }

    if (this.workerInUse()) {
      this.worker.postMessage({ config: this.data, pause: !this.isPlaying });
    } else {
      this.warpspeed.update(this.data);
    }
  },

  initWarpspeed() {
    this.el.removeState("worker");
    if (this.data.useWorker) {
      try {
        const offscreen = this.canvas.transferControlToOffscreen();
        this.worker = new WorkerFactory();
        this.worker.postMessage({ canvas: offscreen }, [offscreen]);
        this.el.addState("worker");
        return
      } catch (e) {
        console.error(e);
      }
    }
    this.warpspeed = new WarpSpeed(this.canvas);
  },

  createCanvasMap() {
    this.canvas = document.createElement("canvas");
    this.canvas.width = this.data.width;
    this.canvas.height = this.data.height;
    this.canvasMap = new THREE.Texture(this.canvas);
    this.el.getObject3D("mesh").material.map = this.canvasMap;
  },

  destroyCanvasMap() {
    if (this.workerInUse()) {
      this.worker.terminate();
      delete this.worker;
    } else {
      delete this.warpspeed;
    }
    this.canvasMap.dispose();
    delete this.canvas;
  },

  play() {
    if (this.workerInUse()) {
      this.worker.postMessage({ pause: false });
    }
  },

  pause() {
    if (this.workerInUse()) {
      this.worker.postMessage({ pause: true });
    }
  },

  workerInUse() {
    return this.el.is("worker")
  },

  tick(_time, timeDelta) {
    if (!this.workerInUse()) {
      this.warpspeed.draw(timeDelta);
    }
    this.canvasMap.needsUpdate = true;
  },
});
